# MMORPG 游戏架构详解

## 适用场景

- 传统 MMO (魔兽世界、剑网三、FF14)
- 开放世界 (原神、塞尔达)
- 传奇类 (传奇、奇迹)
- 仙侠武侠 (诛仙、天涯明月刀)
- 沙盒生存 (方舟、Rust)

## 核心挑战

| 挑战 | 说明 | 解决方案 |
|------|------|---------|
| 大量玩家同屏 | 主城可能 1000+ 玩家 | AOI 区域同步 |
| 持久世界状态 | 玩家数据、世界状态 | 分布式存储 |
| 跨服交互 | 跨服战场、拍卖行 | 消息队列 |
| 无缝大世界 | 地图无加载切换 | 场景分割 + 边界同步 |

## 服务器架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              客户端                                          │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           网关服务器集群                                      │
│  - 连接管理 (TCP 长连接)                                                     │
│  - 协议加解密                                                                │
│  - 消息路由                                                                  │
│  - 负载均衡                                                                  │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                 ┌────────────────────┼────────────────────┐
                 │                    │                    │
                 ▼                    ▼                    ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│     登录服务器       │  │     世界服务器       │  │     跨服服务器       │
│  - 账号验证         │  │  - 场景管理         │  │  - 跨服战场         │
│  - 角色列表         │  │  - 玩家管理         │  │  - 跨服拍卖         │
│  - 服务器列表       │  │  - NPC/怪物         │  │  - 跨服聊天         │
└─────────────────────┘  └──────────┬──────────┘  └─────────────────────┘
                                    │
              ┌─────────────────────┼─────────────────────┐
              │                     │                     │
              ▼                     ▼                     ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│    场景服务器 1      │  │    场景服务器 2      │  │    副本服务器        │
│  ┌───────────────┐  │  │  ┌───────────────┐  │  │  ┌───────────────┐  │
│  │   主城场景    │  │  │  │   野外场景    │  │  │  │   副本实例    │  │
│  │  (高密度)     │  │  │  │  (大范围)     │  │  │  │  (独立房间)   │  │
│  └───────────────┘  │  │  └───────────────┘  │  │  └───────────────┘  │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘
                                    │
              ┌─────────────────────┼─────────────────────┐
              │                     │                     │
              ▼                     ▼                     ▼
┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐
│     聊天服务器       │  │     公会服务器       │  │     排行服务器       │
│  - 世界频道         │  │  - 公会管理         │  │  - 等级排行         │
│  - 私聊            │  │  - 公会战           │  │  - 战力排行         │
│  - 队伍频道         │  │  - 公会仓库         │  │  - 竞技场排行       │
└─────────────────────┘  └─────────────────────┘  └─────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              数据层                                          │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐               │
│  │   Redis   │  │   MySQL   │  │  MongoDB  │  │    MQ     │               │
│  │  (缓存)   │  │  (玩家)   │  │  (日志)   │  │  (跨服)   │               │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘               │
└─────────────────────────────────────────────────────────────────────────────┘
```

## AOI (Area of Interest) 系统

### 九宫格算法

```
┌─────────────────────────────────────────────────────────┐
│                      世界地图                            │
│                                                         │
│    ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┐        │
│    │ 0,0 │ 1,0 │ 2,0 │ 3,0 │ 4,0 │ 5,0 │ 6,0 │        │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┤        │
│    │ 0,1 │ 1,1 │ 2,1 │ 3,1 │ 4,1 │ 5,1 │ 6,1 │        │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┤        │
│    │ 0,2 │ 1,2 │ 2,2 │ 3,2 │ 4,2 │ 5,2 │ 6,2 │        │
│    ├─────┼─────┼─────┼─────┼─────┼─────┼─────┤        │
│    │ 0,3 │ 1,3 │ 2,3 │ 3,3 │ 4,3 │ 5,3 │ 6,3 │        │
│    └─────┴─────┴─────┴─────┴─────┴─────┴─────┘        │
│                                                         │
│    玩家在 (3,2) 格子，AOI 范围 = 九宫格:                  │
│    (2,1) (3,1) (4,1)                                    │
│    (2,2) (3,2) (4,2)                                    │
│    (2,3) (3,3) (4,3)                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### AOI 实现

```java
public class AOIManager {
    public int gridSize = 100;  // 格子大小 100x100
    public Map<String, Set<Long>> grids = new ConcurrentHashMap<>();
    
    // 获取格子 key
    public String getGridKey(float x, float y) {
        int gx = (int) (x / gridSize);
        int gy = (int) (y / gridSize);
        return gx + "," + gy;
    }
    
    // 获取九宫格内所有玩家
    public Set<Long> getNearbyPlayers(float x, float y) {
        Set<Long> result = new HashSet<>();
        int gx = (int) (x / gridSize);
        int gy = (int) (y / gridSize);
        
        for (int dx = -1; dx <= 1; dx++) {
            for (int dy = -1; dy <= 1; dy++) {
                String key = (gx + dx) + "," + (gy + dy);
                Set<Long> players = grids.get(key);
                if (players != null) {
                    result.addAll(players);
                }
            }
        }
        return result;
    }
    
    // 玩家移动
    public void onPlayerMove(long playerId, float oldX, float oldY, float newX, float newY) {
        String oldKey = getGridKey(oldX, oldY);
        String newKey = getGridKey(newX, newY);
        
        if (!oldKey.equals(newKey)) {
            // 跨格子移动
            grids.get(oldKey).remove(playerId);
            grids.computeIfAbsent(newKey, k -> ConcurrentHashMap.newKeySet()).add(playerId);
            
            // 计算离开视野和进入视野的玩家
            Set<Long> oldNearby = getNearbyPlayers(oldX, oldY);
            Set<Long> newNearby = getNearbyPlayers(newX, newY);
            
            Set<Long> leave = new HashSet<>(oldNearby);
            leave.removeAll(newNearby);  // 离开视野
            
            Set<Long> enter = new HashSet<>(newNearby);
            enter.removeAll(oldNearby);  // 进入视野
            
            // 通知相关玩家
            notifyLeave(playerId, leave);
            notifyEnter(playerId, enter);
        }
    }
}
```

## 场景管理

### 场景类型

| 类型 | 特点 | 示例 |
|------|------|------|
| 主城 | 高密度、安全区、NPC 多 | 新手村、王城 |
| 野外 | 大范围、怪物、PK | 平原、森林 |
| 副本 | 独立实例、组队、Boss | 地下城、团本 |
| 战场 | 跨服、PVP、限时 | 攻城战、竞技场 |

### 场景切换

```
┌─────────────────────────────────────────────────────────┐
│                     无缝大世界                           │
│                                                         │
│    ┌───────────────┐    ┌───────────────┐              │
│    │   场景服务1    │    │   场景服务2    │              │
│    │  ┌─────────┐  │    │  ┌─────────┐  │              │
│    │  │  区域A  │──┼────┼──│  区域B  │  │              │
│    │  └─────────┘  │    │  └─────────┘  │              │
│    └───────────────┘    └───────────────┘              │
│                                                         │
│    玩家从 A 走到 B:                                      │
│    1. 在边界时，同时存在于两个场景服务                     │
│    2. 完全进入 B 后，从 A 移除                           │
│    3. 客户端无感知                                       │
└─────────────────────────────────────────────────────────┘
```

## 玩家数据管理

### 数据分层

```
┌─────────────────────────────────────────────────────────┐
│                      玩家数据                            │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │                 热数据 (Redis)                   │   │
│  │  - 在线状态                                      │   │
│  │  - 当前位置                                      │   │
│  │  - 战斗属性                                      │   │
│  │  - 背包 (常用)                                   │   │
│  └─────────────────────────────────────────────────┘   │
│                         │                               │
│                         ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │                 温数据 (MySQL)                   │   │
│  │  - 角色基础信息                                  │   │
│  │  - 装备                                         │   │
│  │  - 技能                                         │   │
│  │  - 任务进度                                      │   │
│  └─────────────────────────────────────────────────┘   │
│                         │                               │
│                         ▼                               │
│  ┌─────────────────────────────────────────────────┐   │
│  │                 冷数据 (归档)                    │   │
│  │  - 历史日志                                      │   │
│  │  - 交易记录                                      │   │
│  │  - 邮件历史                                      │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 数据同步策略

```java
public class PlayerDataManager {
    // 登录时加载
    public Player loadPlayer(long playerId) {
        // 1. 先查 Redis
        Player player = redis.get("player:" + playerId);
        if (player != null) {
            return player;
        }
        
        // 2. 查 MySQL
        player = mysql.query("SELECT * FROM player WHERE id = ?", playerId);
        
        // 3. 写入 Redis
        redis.setex("player:" + playerId, 3600, player);
        
        return player;
    }
    
    // 定时保存 (每 5 分钟)
    public void savePlayer(Player player) {
        // 1. 更新 Redis
        redis.set("player:" + player.id, player);
        
        // 2. 异步写 MySQL
        asyncExecutor.submit(() -> {
            mysql.update("UPDATE player SET ... WHERE id = ?", player);
        });
    }
    
    // 下线时保存
    public void onLogout(Player player) {
        // 同步写 MySQL
        mysql.update("UPDATE player SET ... WHERE id = ?", player);
        // 保留 Redis 缓存 (方便快速重登)
    }
}
```

## 战斗系统

### 技能释放流程

```
客户端                    服务器                    其他客户端
   │                        │                          │
   │  1. 释放技能请求        │                          │
   │ ─────────────────────▶ │                          │
   │                        │                          │
   │                        │ 2. 验证:                  │
   │                        │    - CD 检查              │
   │                        │    - 蓝量检查             │
   │                        │    - 距离检查             │
   │                        │                          │
   │                        │ 3. 计算:                  │
   │                        │    - 伤害计算             │
   │                        │    - 命中判定             │
   │                        │    - Buff 应用            │
   │                        │                          │
   │  4. 技能结果            │  4. 广播技能结果          │
   │ ◀───────────────────── │ ────────────────────────▶│
   │                        │                          │
```

### 伤害公式示例

```java
public class DamageCalculator {
    public int calculate(Unit attacker, Unit target, Skill skill) {
        // 基础伤害
        int baseDamage = attacker.attack * skill.damageRate / 100;
        
        // 防御减免
        int defense = target.defense;
        int reduction = defense * 100 / (defense + 500);  // 防御收益递减
        int damage = baseDamage * (100 - reduction) / 100;
        
        // 暴击
        if (random.nextInt(100) < attacker.critRate) {
            damage = damage * attacker.critDamage / 100;
        }
        
        // 属性克制
        damage = applyElementBonus(damage, attacker.element, target.element);
        
        // 最终伤害
        return Math.max(1, damage);
    }
}
```

## 分线/跨服

### 分线架构

```
┌─────────────────────────────────────────────────────────┐
│                      同一个服务器                        │
│                                                         │
│    ┌─────────┐  ┌─────────┐  ┌─────────┐              │
│    │  1 线   │  │  2 线   │  │  3 线   │              │
│    │ 500人  │  │ 500人  │  │ 500人  │              │
│    └─────────┘  └─────────┘  └─────────┘              │
│                                                         │
│    - 同一地图多个实例                                    │
│    - 玩家可切换线路                                      │
│    - 避免单场景人数过多                                  │
└─────────────────────────────────────────────────────────┘
```

### 跨服架构

```
┌─────────────────────────────────────────────────────────┐
│                                                         │
│    ┌─────────┐  ┌─────────┐  ┌─────────┐              │
│    │ 服务器1 │  │ 服务器2 │  │ 服务器3 │              │
│    └────┬────┘  └────┬────┘  └────┬────┘              │
│         │            │            │                    │
│         └────────────┼────────────┘                    │
│                      │                                  │
│                      ▼                                  │
│              ┌───────────────┐                         │
│              │   跨服中心    │                         │
│              │  - 跨服战场   │                         │
│              │  - 跨服拍卖   │                         │
│              │  - 跨服Boss  │                         │
│              └───────────────┘                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

## 性能优化

### 同步优化

| 优化点 | 方案 |
|--------|------|
| 减少同步频率 | 位置同步 100ms 一次，非关键数据 1s 一次 |
| 减少同步范围 | AOI 只同步视野内 |
| 减少同步数据 | 增量同步，只发变化的字段 |
| 压缩数据 | Protobuf + 压缩 |

### 数据库优化

| 优化点 | 方案 |
|--------|------|
| 读写分离 | 主库写，从库读 |
| 分库分表 | 按玩家 ID 分表 |
| 缓存 | Redis 缓存热数据 |
| 异步写入 | 非关键数据异步落库 |

## 扩展能力

```bash
# 增加场景服务器
docker-compose up -d --scale scene-server=5

# 增加网关
docker-compose up -d --scale gateway=3

# 开新服
# 1. 部署新的世界服务器
# 2. 在登录服务器注册新服
# 3. 配置跨服连接
```
