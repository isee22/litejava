<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœºå™¨äººç®¡ç†åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { opacity: 0.8; font-size: 14px; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .stat-card .label { color: #666; font-size: 13px; margin-bottom: 5px; }
        .stat-card .value { font-size: 28px; font-weight: 600; color: #333; }
        .stat-card .value.green { color: #10b981; }
        .stat-card .value.red { color: #ef4444; }
        .stat-card .value.blue { color: #3b82f6; }
        .stat-card .value.yellow { color: #f59e0b; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card-title { font-size: 16px; font-weight: 600; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px; }
        .filters select, .filters input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .filters button { padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .filters button:hover { background: #5a67d8; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8fafc; font-weight: 600; color: #666; }
        tr:hover { background: #f8fafc; }
        .state { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .state.IDLE { background: #e5e7eb; color: #374151; }
        .state.MATCHING { background: #fef3c7; color: #92400e; }
        .state.CONNECTING { background: #dbeafe; color: #1e40af; }
        .state.IN_ROOM { background: #d1fae5; color: #065f46; }
        .state.GAMING { background: #c7d2fe; color: #3730a3; }
        .state.RECONNECTING { background: #fee2e2; color: #991b1b; }
        .pagination { display: flex; justify-content: center; gap: 5px; margin-top: 15px; }
        .pagination button { padding: 8px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; }
        .pagination button.active { background: #667eea; color: white; border-color: #667eea; }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .state-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .state-bar div { height: 100%; }
        .state-bar .idle { background: #9ca3af; }
        .state-bar .matching { background: #fbbf24; }
        .state-bar .gaming { background: #10b981; }
        .state-bar .error { background: #ef4444; }
        .refresh-btn { background: none; border: none; cursor: pointer; font-size: 18px; }
        .auto-refresh { display: flex; align-items: center; gap: 5px; font-size: 13px; color: #666; }
        .coins { color: #f59e0b; font-weight: 500; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– æœºå™¨äººç®¡ç†åå°</h1>
        <p>å®æ—¶ç›‘æ§æœºå™¨äººçŠ¶æ€ã€é‡‘å¸ã€æ¸¸æˆæ•°æ®</p>
    </div>
    
    <div class="container">
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card"><div class="label">æ€»æœºå™¨äºº</div><div class="value" id="totalRobots">-</div></div>
            <div class="stat-card"><div class="label">æ¸¸æˆä¸­</div><div class="value green" id="gamingCount">-</div></div>
            <div class="stat-card"><div class="label">åŒ¹é…ä¸­</div><div class="value yellow" id="matchingCount">-</div></div>
            <div class="stat-card"><div class="label">ç©ºé—²</div><div class="value" id="idleCount">-</div></div>
            <div class="stat-card"><div class="label">æ€»é‡‘å¸</div><div class="value blue" id="totalCoins">-</div></div>
            <div class="stat-card"><div class="label">æ€»åœºæ¬¡</div><div class="value" id="totalGames">-</div></div>
            <div class="stat-card"><div class="label">èƒœç‡</div><div class="value green" id="winRate">-</div></div>
            <div class="stat-card"><div class="label">èƒœ/è´Ÿ</div><div class="value" id="winLose">-</div></div>
        </div>
        
        <div class="card">
            <div class="card-title">
                <span>çŠ¶æ€åˆ†å¸ƒ</span>
            </div>
            <div class="state-bar" id="stateBar"></div>
            <div id="stateLegend" style="display:flex;gap:20px;margin-top:10px;font-size:13px;color:#666;"></div>
        </div>
        
        <div class="card">
            <div class="card-title">
                <span>æœºå™¨äººåˆ—è¡¨</span>
                <div class="auto-refresh">
                    <input type="checkbox" id="autoRefresh" checked>
                    <label for="autoRefresh">è‡ªåŠ¨åˆ·æ–°</label>
                    <button class="refresh-btn" onclick="loadData()">ğŸ”„</button>
                </div>
            </div>
            
            <div class="filters">
                <select id="filterState" onchange="loadRobots()">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="IDLE">ç©ºé—²</option>
                    <option value="MATCHING">åŒ¹é…ä¸­</option>
                    <option value="GAMING">æ¸¸æˆä¸­</option>
                    <option value="IN_ROOM">æˆ¿é—´ä¸­</option>
                    <option value="RECONNECTING">é‡è¿ä¸­</option>
                </select>
                <select id="filterGame" onchange="loadRobots()">
                    <option value="">å…¨éƒ¨ç©æ³•</option>
                    <option value="doudizhu">æ–—åœ°ä¸»</option>
                    <option value="mahjong">éº»å°†</option>
                    <option value="gobang">äº”å­æ£‹</option>
                    <option value="texas">å¾·å·æ‰‘å…‹</option>
                    <option value="niuniu">ç‰›ç‰›</option>
                </select>
                <input type="text" id="searchId" placeholder="æœç´¢ID..." onkeyup="if(event.key==='Enter')loadRobots()">
                <button onclick="loadRobots()">æœç´¢</button>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>åç§°</th>
                        <th>çŠ¶æ€</th>
                        <th>ç©æ³•</th>
                        <th>æˆ¿é—´</th>
                        <th>åº§ä½</th>
                        <th>é‡‘å¸</th>
                        <th>åœºæ¬¡</th>
                        <th>èƒœç‡</th>
                        <th>æœåŠ¡å™¨</th>
                    </tr>
                </thead>
                <tbody id="robotTable"></tbody>
            </table>
            
            <div class="pagination" id="pagination"></div>
        </div>
    </div>
    
    <script>
        let currentPage = 1;
        const pageSize = 30;
        
        async function loadStats() {
            try {
                const res = await fetch('/stats');
                const json = await res.json();
                if (json.code === 0) {
                    const d = json.data;
                    document.getElementById('totalRobots').textContent = d.totalRobots;
                    document.getElementById('totalCoins').textContent = formatNumber(d.totalCoins);
                    document.getElementById('totalGames').textContent = d.totalGames;
                    document.getElementById('winRate').textContent = d.winRate;
                    document.getElementById('winLose').textContent = d.totalWins + ' / ' + d.totalLoses;
                    
                    const sc = d.stateCount || {};
                    const gaming = (sc.GAMING || 0) + (sc.IN_ROOM || 0) + (sc.CONNECTING || 0);
                    const matching = sc.MATCHING || 0;
                    const idle = sc.IDLE || 0;
                    const error = sc.RECONNECTING || 0;
                    
                    document.getElementById('gamingCount').textContent = gaming;
                    document.getElementById('matchingCount').textContent = matching;
                    document.getElementById('idleCount').textContent = idle;
                    
                    const total = d.totalRobots || 1;
                    const bar = document.getElementById('stateBar');
                    bar.innerHTML = `
                        <div class="gaming" style="width:${gaming/total*100}%"></div>
                        <div class="matching" style="width:${matching/total*100}%"></div>
                        <div class="idle" style="width:${idle/total*100}%"></div>
                        <div class="error" style="width:${error/total*100}%"></div>
                    `;
                    document.getElementById('stateLegend').innerHTML = `
                        <span>ğŸŸ¢ æ¸¸æˆä¸­ ${gaming}</span>
                        <span>ğŸŸ¡ åŒ¹é…ä¸­ ${matching}</span>
                        <span>âšª ç©ºé—² ${idle}</span>
                        <span>ğŸ”´ å¼‚å¸¸ ${error}</span>
                    `;
                }
            } catch (e) { console.error(e); }
        }
        
        async function loadRobots() {
            const state = document.getElementById('filterState').value;
            const game = document.getElementById('filterGame').value;
            const search = document.getElementById('searchId').value;
            
            let url = `/robots?page=${currentPage}&size=${pageSize}`;
            if (state) url += `&state=${state}`;
            if (game) url += `&gameType=${game}`;
            
            try {
                const res = await fetch(url);
                const json = await res.json();
                if (json.code === 0) {
                    const d = json.data;
                    let list = d.list || [];
                    
                    if (search) {
                        list = list.filter(r => String(r.userId).includes(search) || r.name.includes(search));
                    }
                    
                    const tbody = document.getElementById('robotTable');
                    tbody.innerHTML = list.map(r => `
                        <tr>
                            <td>${r.userId}</td>
                            <td>${r.name}</td>
                            <td><span class="state ${r.state}">${stateText(r.state)}</span></td>
                            <td>${r.gameType}:${r.level}</td>
                            <td>${r.roomId || '-'}</td>
                            <td>${r.seatIndex >= 0 ? r.seatIndex : '-'}</td>
                            <td class="coins">ğŸ’° ${formatNumber(r.coins)}</td>
                            <td>${r.totalGames}</td>
                            <td>${r.winRate}</td>
                            <td>${r.serverAddr || '-'}</td>
                        </tr>
                    `).join('');
                    
                    renderPagination(d.total, d.page, d.size);
                }
            } catch (e) { console.error(e); }
        }
        
        function renderPagination(total, page, size) {
            const pages = Math.ceil(total / size);
            const div = document.getElementById('pagination');
            let html = '';
            
            html += `<button ${page <= 1 ? 'disabled' : ''} onclick="goPage(${page-1})">ä¸Šä¸€é¡µ</button>`;
            
            for (let i = 1; i <= Math.min(pages, 10); i++) {
                html += `<button class="${i === page ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
            }
            
            if (pages > 10) html += `<span>... å…±${pages}é¡µ</span>`;
            
            html += `<button ${page >= pages ? 'disabled' : ''} onclick="goPage(${page+1})">ä¸‹ä¸€é¡µ</button>`;
            div.innerHTML = html;
        }
        
        function goPage(p) {
            currentPage = p;
            loadRobots();
        }
        
        function stateText(state) {
            const map = { IDLE: 'ç©ºé—²', MATCHING: 'åŒ¹é…ä¸­', CONNECTING: 'è¿æ¥ä¸­', IN_ROOM: 'æˆ¿é—´ä¸­', GAMING: 'æ¸¸æˆä¸­', RECONNECTING: 'é‡è¿ä¸­' };
            return map[state] || state;
        }
        
        function formatNumber(n) {
            return n >= 10000 ? (n / 10000).toFixed(1) + 'w' : n;
        }
        
        function loadData() {
            loadStats();
            loadRobots();
        }
        
        loadData();
        setInterval(() => {
            if (document.getElementById('autoRefresh').checked) loadData();
        }, 3000);
    </script>
</body>
</html>
