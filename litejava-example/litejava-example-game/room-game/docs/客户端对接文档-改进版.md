# 客户端对接文档（改进版）

## 1. 核心流程概览

### 1.1 架构原则

```
进入游戏前 → HTTP（登录、匹配、房间管理）
进入游戏后 → WebSocket（实时游戏通信）
```

### 1.2 服务端点

| 服务 | 端口 | 协议 | 职责 |
|------|------|------|------|
| AccountServer | 8101 | HTTP | 登录/注册/玩家数据 |
| HallServer | 8201 | HTTP | 房间创建/匹配 |
| GameServer | 9100+ | WebSocket | 游戏实时通信 |

## 2. 完整游戏流程

### 2.1 方案 A：快速开始（推荐）

**适用场景：** 休闲游戏，不关心对手等级，快速进入游戏

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│  客户端  │      │ Account │      │  Hall   │      │  Game   │
└────┬────┘      └────┬────┘      └────┬────┘      └────┬────┘
     │                │                │                │
     │ 1. 登录        │                │                │
     │───────────────►│                │                │
     │   {userId}     │                │                │
     │◄───────────────│                │                │
     │                │                │                │
     │ 2. 快速开始（立即返回）          │                │
     │────────────────────────────────►│                │
     │                │                │ 3. 找房间/创建  │
     │                │                │───────────────►│
     │   {roomId, ip, port, token}     │                │
     │◄────────────────────────────────│                │
     │                │                │                │
     │ 4. WebSocket 连接               │                │
     │─────────────────────────────────────────────────►│
     │ 5. LOGIN {token}                │                │
     │─────────────────────────────────────────────────►│
     │   进入房间成功                   │                │
     │◄─────────────────────────────────────────────────│
     │                │                │                │
     │ 6. READY                        │                │
     │─────────────────────────────────────────────────►│
     │   等待其他人准备...              │                │
     │                │                │                │
     │ 7. GAME_START                   │                │
     │◄─────────────────────────────────────────────────│
```

### 2.2 方案 B：匹配队列（公平匹配）

**适用场景：** 竞技游戏，需要匹配同等级玩家

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│  客户端  │      │ Account │      │  Hall   │      │  Game   │
└────┬────┘      └────┬────┘      └────┬────┘      └────┬────┘
     │                │                │                │
     │ 1. 登录        │                │                │
     │───────────────►│                │                │
     │                │                │                │
     │ 2. 开始匹配    │                │                │
     │────────────────────────────────►│                │
     │   {status: "matching"}          │                │
     │◄────────────────────────────────│                │
     │                │                │                │
     │  (等待 1-30 秒，定时轮询)        │                │
     │                │                │                │
     │ 3. 查询匹配结果 │                │                │
     │────────────────────────────────►│                │
     │   {status: "matched",           │                │
     │    roomId, ip, port, token}     │                │
     │◄────────────────────────────────│                │
     │                │                │                │
     │ 4. WebSocket 连接               │                │
     │─────────────────────────────────────────────────►│
     │ 5. LOGIN {token}                │                │
     │─────────────────────────────────────────────────►│
     │   自动进入房间，无需 READY       │                │
     │◄─────────────────────────────────────────────────│
```

## 3. HTTP API 详解

### 3.1 AccountServer (8101)

#### 登录
```http
POST /auth/login
Content-Type: application/json

{
  "username": "test",
  "password": "123456"
}

# 响应
{
  "code": 0,
  "data": {
    "userId": 10001,
    "name": "玩家昵称",
    "coins": 10000
  }
}
```

#### 获取断线重连信息（新增）
```http
GET /reconnect_info?userId=10001

# 响应（有断线房间）
{
  "code": 0,
  "data": {
    "hasRoom": true,
    "serverId": "127.0.0.1:9100",
    "roomId": "123456",
    "gameType": "doudizhu",
    "ip": "127.0.0.1",
    "port": 9100
  }
}

# 响应（无断线房间）
{
  "code": 0,
  "data": {
    "hasRoom": false
  }
}
```

### 3.2 HallServer (8201)

#### 快速开始（推荐）
```http
GET /quick_start?userId=10001&gameType=doudizhu&level=1&name=玩家1

# 响应（立即返回）
{
  "code": 0,
  "data": {
    "status": "matched",
    "roomId": "123456",
    "ip": "127.0.0.1",
    "port": 9100,
    "token": "eyJhbGc...",
    "gameType": "doudizhu"
  }
}
```

**参数说明：**
- `userId` - 玩家ID（必填）
- `gameType` - 游戏类型（必填）：doudizhu, gobang, mahjong 等
- `level` - 难度等级（可选，默认1）：1=初级, 2=中级, 3=高级
- `name` - 玩家昵称（可选）

**流程说明：**
1. HallServer 查找是否有等待中的房间（人未满）
2. 有 → 直接加入，返回房间信息
3. 无 → 创建新房间，返回房间信息
4. **同步返回，无需轮询**

#### 开始匹配
```http
POST /match/start
Content-Type: application/json

{
  "userId": 10001,
  "gameType": "doudizhu",
  "level": 1,
  "name": "玩家1"
}

# 响应（匹配中）
{
  "code": 0,
  "data": {
    "status": "matching"
  }
}

# 响应（匹配成功，需轮询获取）
{
  "code": 0,
  "data": {
    "status": "matched",
    "roomId": "234567",
    "ip": "127.0.0.1",
    "port": 9100,
    "token": "eyJhbGc...",
    "gameType": "doudizhu"
  }
}
```

**轮询建议：**
- 间隔：500ms
- 超时：30 秒
- 超时后调用 `/match/cancel` 取消匹配

#### 取消匹配
```http
POST /match/cancel
Content-Type: application/json

{
  "userId": 10001
}

# 响应
{
  "code": 0
}
```

#### 创建私人房间
```http
GET /create_private_room?userId=10001&gameType=doudizhu&conf={}

# 响应
{
  "code": 0,
  "data": {
    "roomId": "123456",
    "ip": "127.0.0.1",
    "port": 9100,
    "token": "eyJhbGc..."
  }
}
```

#### 加入私人房间
```http
GET /enter_private_room?userId=10002&roomid=123456&name=玩家2

# 响应
{
  "code": 0,
  "data": {
    "roomId": "123456",
    "ip": "127.0.0.1",
    "port": 9100,
    "token": "eyJhbGc..."
  }
}
```

## 4. WebSocket 协议

### 4.1 连接地址
```
ws://{ip}:{port}/game
```

**注意：** 路径固定为 `/game`，不再是 `/{gameType}`

### 4.2 消息格式

```json
// 客户端请求
{
  "cmd": 1,
  "data": {
    "token": "eyJhbGc..."
  }
}

// 服务端响应（成功）
{
  "cmd": 1,
  "code": 0,
  "data": {
    "roomId": "123456",
    "seatIndex": 0,
    "seats": [...]
  }
}

// 服务端响应（失败）
{
  "cmd": 1,
  "code": 5,
  "msg": "token invalid"
}
```

### 4.3 登录（cmd=1）

**请求：**
```json
{
  "cmd": 1,
  "data": {
    "token": "eyJhbGc..."
  }
}
```

**响应：**
```json
{
  "cmd": 1,
  "code": 0,
  "data": {
    "roomId": "123456",
    "ownerId": 10001,
    "seatIndex": 0,
    "seats": [
      {
        "seatIndex": 0,
        "userId": 10001,
        "name": "玩家1",
        "ready": false,
        "online": true
      },
      {
        "seatIndex": 1,
        "userId": 0,
        "name": "",
        "ready": false,
        "online": false
      }
    ],
    "game": null
  }
}
```

**断线重连时：**
```json
{
  "cmd": 1,
  "code": 0,
  "data": {
    "roomId": "123456",
    "seatIndex": 0,
    "seats": [...],
    "game": {
      "status": 1,
      "currentSeat": 2,
      "myCards": [3, 4, 5, 6, 7],
      "landlordSeat": 0
    }
  }
}
```

### 4.4 心跳（cmd=4）

**建议：** 每 30 秒发送一次

```json
// 请求
{"cmd": 4}

// 响应
{"cmd": 4, "code": 0}
```

**超时机制：**
- 服务端 60 秒未收到心跳 → 断开连接
- 客户端 60 秒未收到响应 → 重连

### 4.5 准备（cmd=504）

```json
// 请求
{"cmd": 504}

// 响应
{"cmd": 504, "code": 0}

// 广播给房间所有人
{
  "cmd": 504,
  "code": 0,
  "data": {
    "userId": 10001,
    "seatIndex": 0,
    "ready": true
  }
}
```

**自动开始：**
当所有玩家都准备后，服务端自动发送 `GAME_START (510)`

### 4.6 退出房间（cmd=104）

```json
// 请求
{"cmd": 104}

// 响应
{"cmd": 104, "code": 0}
```

**注意：** 游戏进行中不能退出

## 5. 通用推送消息

| cmd | 名称 | 说明 |
|-----|------|------|
| 500 | USER_JOIN | 有人加入房间 |
| 501 | USER_EXIT | 有人退出房间 |
| 502 | USER_STATE | 玩家状态变化（上线/离线/托管） |
| 503 | USER_READY | 玩家准备状态 |
| 510 | GAME_START | 游戏开始 |
| 511 | GAME_OVER | 游戏结束 |
| 520 | DEAL | 发牌 |
| 522 | TURN | 轮到谁操作 |

### 5.1 有人加入（cmd=500）
```json
{
  "cmd": 500,
  "code": 0,
  "data": {
    "userId": 10002,
    "seatIndex": 1,
    "name": "玩家2"
  }
}
```

### 5.2 玩家状态变化（cmd=502）
```json
{
  "cmd": 502,
  "code": 0,
  "data": {
    "userId": 10001,
    "online": false,      // 离线
    "trusteeship": false  // 是否托管
  }
}
```

### 5.3 游戏开始（cmd=510）
```json
{
  "cmd": 510,
  "code": 0,
  "data": {
    "numOfGames": 1,
    "bidSeat": 0
  }
}
```

### 5.4 游戏结束（cmd=511）
```json
{
  "cmd": 511,
  "code": 0,
  "data": {
    "winner": 0,
    "scores": [200, -100, -100],
    "settlements": [
      {
        "userId": 10001,
        "win": true,
        "score": 200,
        "coinChange": 200,
        "exp": 20
      }
    ]
  }
}
```

## 6. 错误码表

| code | 说明 | 处理建议 |
|------|------|----------|
| 0 | 成功 | - |
| 1 | 房间已满 | 提示用户，返回大厅 |
| 2 | 房间不存在 | 提示用户，返回大厅 |
| 3 | 未登录 | 重新登录 |
| 4 | 不在房间中 | 返回大厅 |
| 5 | Token 无效 | 重新获取 token |
| 6 | 不是你的回合 | 等待 |
| 7 | 无效操作 | 提示用户 |
| 8 | 游戏未开始 | 等待 |
| 9 | 没有可用服务器 | 稍后重试 |

## 7. 示例代码

### 7.1 JavaScript 完整流程

```javascript
class GameClient {
  constructor() {
    this.ws = null
    this.userId = null
    this.token = null
  }
  
  // 1. 登录
  async login(username, password) {
    const resp = await fetch('http://localhost:8101/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    })
    const result = await resp.json()
    if (result.code === 0) {
      this.userId = result.data.userId
      return result.data
    }
    throw new Error('登录失败')
  }
  
  // 2. 检查断线重连
  async checkReconnect() {
    const resp = await fetch(
      `http://localhost:8101/reconnect_info?userId=${this.userId}`
    )
    const result = await resp.json()
    if (result.code === 0 && result.data.hasRoom) {
      return result.data
    }
    return null
  }
  
  // 3. 快速开始（推荐）
  async quickStart(gameType, name) {
    const resp = await fetch(
      `http://localhost:8201/quick_start?userId=${this.userId}&gameType=${gameType}&level=1&name=${name}`
    )
    const result = await resp.json()
    if (result.code === 0) {
      return result.data
    }
    throw new Error('快速开始失败')
  }
  
  // 4. 连接游戏服务器
  async connectGame(ip, port, token) {
    return new Promise((resolve, reject) => {
      this.ws = new WebSocket(`ws://${ip}:${port}/game`)
      this.token = token
      
      this.ws.onopen = () => {
        // 发送登录
        this.send(1, { token })
      }
      
      this.ws.onmessage = (e) => {
        const msg = JSON.parse(e.data)
        
        if (msg.cmd === 1) {
          if (msg.code === 0) {
            resolve(msg.data)
          } else {
            reject(new Error('登录失败: ' + msg.msg))
          }
        }
        
        this.onMessage(msg)
      }
      
      this.ws.onerror = (err) => reject(err)
      this.ws.onclose = () => this.onDisconnect()
    })
  }
  
  // 5. 准备
  ready() {
    this.send(504, {})
  }
  
  // 发送消息
  send(cmd, data) {
    this.ws.send(JSON.stringify({ cmd, data }))
  }
  
  // 处理消息
  onMessage(msg) {
    switch (msg.cmd) {
      case 500:
        console.log('有人加入:', msg.data)
        break
      case 510:
        console.log('游戏开始:', msg.data)
        break
      case 511:
        console.log('游戏结束:', msg.data)
        this.onGameOver(msg.data)
        break
      case 520:
        console.log('发牌:', msg.data)
        break
      case 522:
        console.log('轮到:', msg.data)
        break
    }
  }
  
  // 断线处理
  onDisconnect() {
    console.log('连接断开，尝试重连...')
    setTimeout(() => this.reconnect(), 3000)
  }
  
  // 断线重连
  async reconnect() {
    const info = await this.checkReconnect()
    if (info && info.hasRoom) {
      // 重新获取 token
      const resp = await fetch(
        `http://localhost:8201/enter_private_room?userId=${this.userId}&roomid=${info.roomId}&name=玩家`
      )
      const result = await resp.json()
      if (result.code === 0) {
        await this.connectGame(info.ip, info.port, result.data.token)
      }
    }
  }
  
  // 游戏结束
  onGameOver(data) {
    // 显示结算界面
    console.log('结算:', data.settlements)
  }
}

// 使用示例
async function main() {
  const client = new GameClient()
  
  // 登录
  await client.login('test', '123456')
  
  // 检查断线重连
  const reconnectInfo = await client.checkReconnect()
  if (reconnectInfo) {
    console.log('检测到断线房间，正在重连...')
    // 重连逻辑...
    return
  }
  
  // 快速开始
  const matchResult = await client.quickStart('doudizhu', '玩家1')
  console.log('匹配成功:', matchResult)
  
  // 连接游戏
  const roomInfo = await client.connectGame(
    matchResult.ip,
    matchResult.port,
    matchResult.token
  )
  console.log('进入房间:', roomInfo)
  
  // 准备
  client.ready()
}

main().catch(console.error)
```

## 8. 常见问题

### Q1: token 过期怎么办？
A: token 有效期 5 分钟，过期后需要重新调用 `/enter_private_room` 获取新 token

### Q2: 断线后如何重连？
A: 
1. 调用 `/reconnect_info` 获取房间信息
2. 调用 `/enter_private_room` 获取新 token
3. 重新建立 WebSocket 连接
4. 发送 LOGIN 命令，服务端会返回游戏状态

### Q3: 快速开始 vs 匹配队列，如何选择？
A:
- **快速开始**：适合休闲游戏，立即返回，无需等待
- **匹配队列**：适合竞技游戏，需要匹配同等级玩家

### Q4: 游戏中断线会怎样？
A:
- 5 秒内重连 → 继续游戏
- 5 秒后 → 自动托管（AI 代打）
- 60 秒后 → 踢出房间

### Q5: 如何处理网络波动？
A:
- 发送心跳（30 秒间隔）
- 监听 WebSocket close 事件
- 自动重连（最多 3 次）

## 9. 调试技巧

### 9.1 查看服务器状态
```http
GET http://localhost:9101/status

{
  "errcode": 0,
  "data": {
    "serverId": "127.0.0.1:9100",
    "rooms": 5,
    "players": 12
  }
}
```

### 9.2 查看房间信息
```http
GET http://localhost:9101/room/123456

{
  "errcode": 0,
  "data": {
    "roomId": "123456",
    "ownerId": 10001,
    "playerCount": 3,
    "maxPlayers": 3,
    "gaming": true,
    "seats": [...]
  }
}
```

### 9.3 启用日志
```javascript
// 客户端
ws.onmessage = (e) => {
  console.log('[收到]', e.data)
  // ...
}

ws.send = (data) => {
  console.log('[发送]', data)
  WebSocket.prototype.send.call(ws, data)
}
```

## 10. 下一步

- [斗地主协议](./game/斗地主协议.md)
- [五子棋协议](./game/五子棋协议.md)
- [麻将协议](./game/麻将协议.md)
- [错误排查指南](./故障排查指南.md)
