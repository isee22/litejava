# 狼人杀游戏协议文档

## 概述

狼人杀是一款社交推理游戏，玩家分为好人阵营和狼人阵营。本文档描述客户端与狼人杀游戏服务器之间的通信协议。

## 连接信息

- WebSocket端口: 9600
- HTTP管理端口: 9601
- 路径: `/game`

## 角色配置

### 角色定义

| 角色ID | 角色名 | 阵营 | 技能 |
|--------|--------|------|------|
| 0 | 村民 | 好人 | 无特殊技能 |
| 1 | 狼人 | 狼人 | 夜晚可以杀死一名玩家 |
| 2 | 预言家 | 好人 | 夜晚可以查验一名玩家的身份 |
| 3 | 女巫 | 好人 | 拥有解药和毒药各一瓶 |
| 4 | 守卫 | 好人 | 夜晚可以守护一名玩家 |
| 5 | 猎人 | 好人 | 死亡时可以开枪带走一人 |

### 人数配置

| 人数 | 狼人 | 预言家 | 女巫 | 守卫 | 猎人 | 村民 |
|------|------|--------|------|------|------|------|
| 6人  | 2    | 1      | 1    | -    | -    | 2    |
| 8人  | 2    | 1      | 1    | 1    | 1    | 2    |
| 9人  | 3    | 1      | 1    | 1    | 1    | 2    |
| 12人 | 4    | 1      | 1    | 1    | 1    | 4    |

## 游戏阶段

| 阶段ID | 阶段名 | 说明 |
|--------|--------|------|
| 0 | NIGHT_START | 夜晚开始 |
| 1 | WOLF_TURN | 狼人回合 |
| 2 | SEER_TURN | 预言家回合 |
| 3 | WITCH_TURN | 女巫回合 |
| 4 | GUARD_TURN | 守卫回合 |
| 5 | DAY_START | 白天开始 |
| 6 | SPEAK | 发言阶段 |
| 7 | VOTE | 投票阶段 |
| 8 | LAST_WORDS | 遗言阶段 |
| 9 | GAME_OVER | 游戏结束 |

## 游戏流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         游戏开始                                 │
│                      分配角色并通知                              │
│                   (狼人互相知道同伴)                             │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【夜晚阶段】                               │
│                                                                 │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │
│  │ 狼人杀人  │ → │预言家查验 │ → │ 女巫用药  │ → │ 守卫守护  │  │
│  │ (投票)   │    │ (查身份) │    │(救/毒)   │    │ (保护)   │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【白天阶段】                               │
│                                                                 │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │
│  │ 公布死讯  │ → │   遗言   │ → │   发言   │ → │   投票   │  │
│  │          │    │ (死者)   │    │ (轮流)   │    │ (公投)   │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │
└─────────────────────────────────────────────────────────────────┘
                               ↓
                    检查胜负 → 未结束则回到夜晚
```


## 命令号定义 (700-799)

### 夜晚阶段命令

| cmd | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 701 | WOLF_KILL | C→S | 狼人杀人 |
| 702 | WOLF_KILL_RESULT | S→C | 狼人杀人结果 |
| 703 | SEER_CHECK | C→S | 预言家查验 |
| 704 | SEER_CHECK_RESULT | S→C | 查验结果 |
| 705 | WITCH_USE | C→S | 女巫用药 |
| 706 | WITCH_USE_RESULT | S→C | 用药结果 |
| 707 | GUARD_PROTECT | C→S | 守卫守护 |
| 708 | GUARD_PROTECT_RESULT | S→C | 守护结果 |
| 709 | HUNTER_SHOOT | C→S | 猎人开枪 |
| 710 | HUNTER_SHOOT_RESULT | S→C | 开枪结果 |

### 白天阶段命令

| cmd | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 720 | SPEAK | C→S | 发言 |
| 721 | SPEAK_BROADCAST | S→C | 发言广播 |
| 722 | VOTE | C→S | 投票 |
| 723 | VOTE_RESULT | S→C | 投票结果 |
| 724 | LAST_WORDS | C→S | 遗言 |
| 725 | LAST_WORDS_BROADCAST | S→C | 遗言广播 |

### 系统通知命令

| cmd | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 730 | PHASE_CHANGE | S→C | 阶段变更 |
| 731 | DEATH_ANNOUNCE | S→C | 死亡通知 |
| 732 | GAME_OVER | S→C | 游戏结束 |
| 733 | ROLE_ASSIGN | S→C | 角色分配 |
| 734 | YOUR_TURN | S→C | 轮到行动 |
| 735 | WOLF_TEAMMATES | S→C | 狼人同伴 |

## 协议详情

### 1. 角色分配 (ROLE_ASSIGN - 733)

游戏开始时，服务器向每个玩家发送其角色信息。

```json
// S→C
{
  "cmd": 733,
  "code": 0,
  "data": {
    "role": 2,
    "roleName": "预言家"
  }
}
```

### 2. 狼人同伴 (WOLF_TEAMMATES - 735)

游戏开始时，服务器向狼人玩家发送同伴信息。

```json
// S→C (仅狼人)
{
  "cmd": 735,
  "code": 0,
  "data": {
    "wolfSeats": [0, 4]
  }
}
```

### 3. 阶段变更 (PHASE_CHANGE - 730)

```json
// S→C
{
  "cmd": 730,
  "code": 0,
  "data": {
    "phase": 1,
    "day": 1,
    "phaseName": "狼人请睁眼",
    "currentSpeaker": -1
  }
}
```

### 4. 轮到行动 (YOUR_TURN - 734)

通知玩家轮到其行动。

```json
// S→C (通用格式)
{
  "cmd": 734,
  "code": 0,
  "data": {
    "action": "kill",  // kill/check/protect/speak/vote/shoot
    "targets": [0, 2, 3, 4, 5],
    "timeout": 30
  }
}

// S→C (女巫特殊格式)
{
  "cmd": 734,
  "code": 0,
  "data": {
    "action": "witch",
    "killedSeat": 3,
    "hasAntidote": true,
    "hasPoison": true,
    "poisonTargets": [0, 1, 2, 4, 5],
    "timeout": 20
  }
}
```


### 5. 狼人杀人 (WOLF_KILL - 701)

```json
// C→S
{
  "cmd": 701,
  "data": {
    "targetSeat": 3  // -1表示空刀
  }
}

// S→C (通知所有狼人)
{
  "cmd": 702,
  "code": 0,
  "data": {
    "wolfSeat": 0,
    "targetSeat": 3,
    "confirmed": true,
    "finalTarget": 3
  }
}
```

### 6. 预言家查验 (SEER_CHECK - 703)

```json
// C→S
{
  "cmd": 703,
  "data": {
    "targetSeat": 2
  }
}

// S→C (仅预言家)
{
  "cmd": 704,
  "code": 0,
  "data": {
    "targetSeat": 2,
    "isWolf": true
  }
}
```

### 7. 女巫用药 (WITCH_USE - 705)

```json
// C→S
{
  "cmd": 705,
  "data": {
    "useAntidote": true,
    "usePoison": false,
    "poisonTarget": -1
  }
}

// S→C (仅女巫)
{
  "cmd": 706,
  "code": 0,
  "data": {
    "antidoteUsed": true,
    "poisonUsed": false
  }
}
```

### 8. 守卫守护 (GUARD_PROTECT - 707)

```json
// C→S
{
  "cmd": 707,
  "data": {
    "targetSeat": 1
  }
}

// S→C (仅守卫)
{
  "cmd": 708,
  "code": 0,
  "data": {
    "targetSeat": 1
  }
}
```

### 9. 死亡通知 (DEATH_ANNOUNCE - 731)

```json
// S→C
{
  "cmd": 731,
  "code": 0,
  "data": {
    "deadSeats": [3, 5],
    "reason": "昨晚死亡"
  }
}
```

### 10. 发言 (SPEAK - 720)

```json
// C→S
{
  "cmd": 720,
  "data": {
    "content": "我是预言家，昨晚查了3号是狼人"
  }
}

// S→C (广播)
{
  "cmd": 721,
  "code": 0,
  "data": {
    "seatIndex": 2,
    "userId": 10001,
    "content": "我是预言家，昨晚查了3号是狼人"
  }
}
```

### 11. 投票 (VOTE - 722)

```json
// C→S
{
  "cmd": 722,
  "data": {
    "targetSeat": 3  // -1表示弃票
  }
}

// S→C (广播)
{
  "cmd": 723,
  "code": 0,
  "data": {
    "votes": {"0": 3, "1": 3, "2": 5, "4": 3, "5": 3},
    "eliminatedSeat": 3  // -1表示平票
  }
}
```

### 12. 猎人开枪 (HUNTER_SHOOT - 709)

```json
// C→S
{
  "cmd": 709,
  "data": {
    "targetSeat": 5  // -1表示不开枪
  }
}

// S→C (广播)
{
  "cmd": 710,
  "code": 0,
  "data": {
    "hunterSeat": 3,
    "targetSeat": 5
  }
}
```

### 13. 游戏结束 (GAME_OVER - 732)

```json
// S→C
{
  "cmd": 732,
  "code": 0,
  "data": {
    "winner": 1,  // 1=好人胜, 2=狼人胜
    "winnerName": "好人阵营",
    "roles": {
      "0": 1,
      "1": 2,
      "2": 0
    }
  }
}
```


## 错误码

| 错误码 | 说明 |
|--------|------|
| 701 | 不是你的回合 |
| 702 | 目标无效 |
| 703 | 目标已死亡 |
| 704 | 不是当前阶段 |
| 705 | 你没有这个角色 |
| 706 | 解药已用完 |
| 707 | 毒药已用完 |
| 708 | 不能连续守护同一人 |
| 709 | 已经投过票 |
| 710 | 你已死亡 |
| 711 | 不能自杀 |
| 712 | 狼人还未统一意见 |

## 特殊规则

1. **狼人投票**: 多个狼人需要投票选择目标，票数最多的目标被杀
2. **女巫自救**: 第一晚女巫可以自救（可配置）
3. **同守同救**: 守卫和女巫同时保护同一人，该人仍然死亡
4. **守卫限制**: 不能连续两晚守护同一人
5. **猎人被毒**: 被女巫毒死的猎人不能开枪
6. **平票处理**: 投票平票时无人出局

## 断线重连

断线重连时，服务器会返回当前游戏状态：

```json
{
  "cmd": 2,
  "code": 0,
  "data": {
    "roomId": "room_123",
    "seats": [...],
    "game": {
      "day": 2,
      "phase": 6,
      "myRole": 2,
      "alive": [true, true, false, true, false, true, true, true],
      "wolfSeats": null  // 仅狼人可见
    }
  }
}
```

## 客户端实现要点

1. **角色UI**: 根据角色显示不同的操作界面
2. **夜晚遮罩**: 夜晚阶段显示遮罩，只有轮到自己时才能操作
3. **倒计时**: 每个操作都有超时时间，超时自动跳过
4. **狼人视角**: 狼人可以看到同伴，并实时看到其他狼人的投票
5. **死亡状态**: 死亡玩家显示灰色，不能操作
6. **游戏记录**: 记录所有发言和投票，方便玩家回顾