# MOBA游戏协议文档

## 概述

MOBA（多人在线战术竞技）游戏服务器示例，展示帧同步架构，支持最多10人（5v5）。本文档描述客户端与MOBA游戏服务器之间的通信协议。

**注意：这是一个简化的示例，用于演示帧同步游戏的基本架构。**

## 连接信息

- WebSocket端口: 9600
- HTTP管理端口: 9601
- 路径: `/game`

## 帧同步架构

```
┌─────────────────────────────────────────────────────────────┐
│                      帧同步架构                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  客户端1 ──┐                                                │
│  客户端2 ──┼──> 服务器收集输入 ──> 广播帧数据 ──> 所有客户端  │
│  客户端3 ──┘         │                                      │
│                      ▼                                      │
│              每帧 (如 66ms)                                  │
│              收集所有玩家输入                                 │
│              打包成帧数据                                    │
│              广播给所有客户端                                 │
│              客户端本地模拟                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 游戏流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                       【匹配阶段】                               │
│                    10人匹配成功                                 │
│                   分配红蓝两队                                  │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                      【选英雄阶段】                              │
│                                                                 │
│                    每人选择英雄                                  │
│                   禁选/轮选模式                                  │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【加载阶段】                               │
│                                                                 │
│                  等待所有人加载完成                              │
│                   同步加载进度                                   │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【游戏开始】                               │
│                                                                 │
│                    初始化地图                                    │
│                    生成小兵                                      │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                    【游戏循环 - 帧同步】                         │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                                                          │  │
│  │  收集玩家输入 ──> 打包帧数据 ──> 广播 ──> 本地模拟       │  │
│  │  (MOVE/ATTACK/SKILL)   (FRAME)                           │  │
│  │                                                          │  │
│  │  每帧循环（如15帧/秒，66ms/帧）                           │  │
│  │                                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                        【游戏结束】                              │
│                                                                 │
│                   一方基地被摧毁                                 │
│                    结算战绩                                      │
└─────────────────────────────────────────────────────────────────┘
```

## 游戏阶段

| 阶段 | 英文名 | 说明 |
|------|--------|------|
| 匹配 | MATCHING | 等待10人匹配 |
| 选英雄 | HERO_SELECT | 选择英雄 |
| 加载 | LOADING | 等待加载完成 |
| 游戏中 | PLAYING | 帧同步游戏循环 |
| 结算 | SETTLE | 游戏结束结算 |

## 命令号定义 (6001-6010)

| cmd | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 6001 | MOVE | C→S | 移动指令 |
| 6002 | ATTACK | C→S | 普通攻击 |
| 6003 | SKILL | C→S | 释放技能 |
| 6004 | ATTACK_BASE | C→S | 攻击基地 |
| 6005 | SELECT_HERO | C→S | 选择英雄 |
| 6006 | LOAD_PROGRESS | C→S | 加载进度 |
| 6007 | HERO_SELECTED | S→C | 英雄选择结果 |
| 6008 | LOAD_COMPLETE | S→C | 加载完成通知 |
| 6009 | GAME_START | S→C | 游戏开始 |
| 6010 | FRAME | S→C | 帧同步数据 |

## 协议详情

### 1. 选择英雄 (SELECT_HERO - 6005)

```json
// C→S
{
  "cmd": 6005,
  "data": {
    "heroId": 101
  }
}

// S→C (广播)
{
  "cmd": 6007,
  "code": 0,
  "data": {
    "userId": 10001,
    "seat": 0,
    "heroId": 101,
    "heroName": "战士"
  }
}
```

### 2. 加载进度 (LOAD_PROGRESS - 6006)

```json
// C→S
{
  "cmd": 6006,
  "data": {
    "progress": 75
  }
}

// S→C (广播所有人进度)
{
  "cmd": 6006,
  "code": 0,
  "data": {
    "players": [
      {"userId": 10001, "progress": 100},
      {"userId": 10002, "progress": 75},
      {"userId": 10003, "progress": 50}
    ]
  }
}
```

### 3. 加载完成 (LOAD_COMPLETE - 6008)

```json
// S→C
{
  "cmd": 6008,
  "code": 0,
  "data": {
    "allReady": true
  }
}
```

### 4. 游戏开始 (GAME_START - 6009)

```json
// S→C
{
  "cmd": 6009,
  "code": 0,
  "data": {
    "mapId": 1,
    "teams": {
      "red": [10001, 10002, 10003, 10004, 10005],
      "blue": [10006, 10007, 10008, 10009, 10010]
    },
    "heroes": {
      "10001": {"heroId": 101, "x": 100, "y": 100},
      "10002": {"heroId": 102, "x": 120, "y": 100}
    },
    "frameRate": 15,
    "randomSeed": 12345
  }
}
```

### 5. 移动 (MOVE - 6001)

```json
// C→S
{
  "cmd": 6001,
  "data": {
    "x": 100,
    "y": 200
  }
}
```

### 6. 攻击 (ATTACK - 6002)

```json
// C→S
{
  "cmd": 6002,
  "data": {
    "targetId": 10002
  }
}
```

### 7. 技能 (SKILL - 6003)

```json
// C→S (指向性技能)
{
  "cmd": 6003,
  "data": {
    "skillId": 1,
    "targetId": 10002
  }
}

// C→S (方向性技能)
{
  "cmd": 6003,
  "data": {
    "skillId": 2,
    "x": 150,
    "y": 250
  }
}

// C→S (范围技能)
{
  "cmd": 6003,
  "data": {
    "skillId": 3,
    "x": 200,
    "y": 300,
    "radius": 50
  }
}
```

### 8. 攻击基地 (ATTACK_BASE - 6004)

```json
// C→S
{
  "cmd": 6004,
  "data": {
    "baseId": 1
  }
}
```

### 9. 帧数据 (FRAME - 6010)

服务器每帧广播所有玩家的输入。

```json
// S→C
{
  "cmd": 6010,
  "code": 0,
  "data": {
    "frame": 100,
    "serverTime": 1704067200000,
    "inputs": [
      {"userId": 10001, "cmd": 6001, "x": 100, "y": 200},
      {"userId": 10002, "cmd": 6002, "targetId": 10001},
      {"userId": 10003, "cmd": 6003, "skillId": 1, "x": 150, "y": 250}
    ]
  }
}
```

### 10. 游戏结束

```json
// S→C
{
  "cmd": 102,
  "code": 0,
  "data": {
    "winner": "red",
    "duration": 1800,
    "stats": [
      {
        "userId": 10001,
        "team": "red",
        "heroId": 101,
        "kills": 5,
        "deaths": 2,
        "assists": 10,
        "damage": 15000,
        "gold": 8000
      }
    ]
  }
}
```

## 帧同步机制

### 基本原理

1. 客户端发送操作指令到服务器
2. 服务器收集所有玩家在当前帧的输入
3. 服务器将帧数据广播给所有客户端
4. 客户端根据帧数据进行本地模拟

### 帧率设置

| 参数 | 值 | 说明 |
|------|-----|------|
| 逻辑帧率 | 15 FPS | 服务器广播频率 |
| 帧间隔 | 66ms | 每帧时间间隔 |
| 渲染帧率 | 60 FPS | 客户端渲染频率 |

### 输入收集

```
时间线:
0ms      66ms     132ms    198ms
|--------|--------|--------|
  帧1      帧2      帧3

客户端在帧间隔内发送的所有输入
都会被收集到下一帧中广播
```

### 确定性模拟

为保证所有客户端模拟结果一致，需要：

1. 使用相同的随机种子
2. 使用定点数代替浮点数
3. 相同的物理引擎参数
4. 相同的逻辑更新顺序

## 帧同步 vs 状态同步

| 特性 | 帧同步 | 状态同步 |
|-----|--------|---------|
| 服务器计算 | 少（只转发输入） | 多（计算所有逻辑） |
| 带宽消耗 | 低（只传输入） | 高（传状态） |
| 延迟敏感 | 高 | 中 |
| 回放实现 | 简单（重放输入） | 复杂（记录状态） |
| 反作弊 | 较难 | 较易 |
| 适用场景 | RTS/MOBA | MMO/FPS |

## 错误码

| 错误码 | 说明 |
|--------|------|
| 6001 | 英雄已被选择 |
| 6002 | 无效的英雄ID |
| 6003 | 不在选英雄阶段 |
| 6004 | 游戏未开始 |
| 6005 | 技能冷却中 |
| 6006 | 目标无效 |
| 6007 | 距离太远 |
| 6008 | 已死亡 |

## 断线重连

### 重连流程

1. 客户端检测到断线
2. 重新连接WebSocket
3. 发送重连请求（携带userId和roomId）
4. 服务器返回当前游戏状态和历史帧数据
5. 客户端快速追帧到当前状态

### 重连响应

```json
{
  "cmd": 2,
  "code": 0,
  "data": {
    "roomId": "room_123",
    "currentFrame": 500,
    "gameState": {
      "teams": {...},
      "heroes": {...}
    },
    "missedFrames": [
      {"frame": 498, "inputs": [...]},
      {"frame": 499, "inputs": [...]},
      {"frame": 500, "inputs": [...]}
    ]
  }
}
```

### 追帧机制

1. 客户端收到历史帧数据
2. 加速模拟（如4倍速）执行历史帧
3. 追上当前帧后恢复正常速度
4. 追帧期间可显示加载界面

## 客户端实现要点

1. **确定性模拟**: 确保相同输入产生相同结果
2. **输入预测**: 本地先执行，收到服务器确认后校正
3. **平滑插值**: 渲染帧率高于逻辑帧率时进行插值
4. **延迟补偿**: 根据网络延迟调整显示
5. **断线检测**: 检测帧数据中断，提示重连
6. **追帧优化**: 断线重连时快速追帧
7. **回放系统**: 保存帧数据用于回放

## 注意事项

1. 这是简化示例，实际MOBA游戏需要更复杂的实现
2. 帧同步需要处理网络延迟、丢包、断线重连等问题
3. 客户端需要实现确定性模拟（相同输入产生相同结果）
4. 建议使用UDP协议减少延迟（本示例使用WebSocket）
5. 大规模战斗可能需要AOI（Area of Interest）优化
