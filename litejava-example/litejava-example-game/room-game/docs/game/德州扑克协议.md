# 德州扑克游戏协议文档

## 概述

德州扑克是一款经典的扑克牌游戏，支持2-9人同时游戏。本文档描述客户端与德州扑克游戏服务器之间的通信协议。

## 连接信息

- WebSocket端口: 9400
- HTTP管理端口: 9401
- 路径: `/game`

## 游戏流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         游戏开始                                 │
│                    确定庄家位置                                  │
│                  小盲/大盲强制下注                               │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【发底牌】                                 │
│                    每人发2张底牌                                 │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                    【翻牌前 Pre-Flop】                           │
│                                                                 │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │
│  │   跟注   │    │   加注   │    │   过牌   │    │   弃牌   │  │
│  │  (CALL)  │    │ (RAISE)  │    │ (CHECK)  │    │  (FOLD)  │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │
│                      从大盲下家开始行动                          │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                      【翻牌 Flop】                               │
│                    发3张公共牌                                   │
│                    新一轮下注                                    │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                      【转牌 Turn】                               │
│                   发第4张公共牌                                  │
│                    新一轮下注                                    │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                      【河牌 River】                              │
│                   发第5张公共牌                                  │
│                   最后一轮下注                                   │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                      【摊牌 Showdown】                           │
│                    比较牌型大小                                  │
│                     分配底池                                     │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                        游戏结束                                  │
│                      庄家轮换                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 游戏阶段

| 阶段 | 英文名 | 说明 |
|------|--------|------|
| 准备 | WAITING | 等待玩家准备 |
| 发牌 | DEAL | 发2张底牌 |
| 翻牌前 | PRE_FLOP | 第一轮下注 |
| 翻牌 | FLOP | 发3张公共牌，第二轮下注 |
| 转牌 | TURN | 发第4张公共牌，第三轮下注 |
| 河牌 | RIVER | 发第5张公共牌，最后一轮下注 |
| 摊牌 | SHOWDOWN | 比较牌型，分配底池 |
| 结算 | SETTLE | 游戏结束，结算筹码 |

## 命令号定义 (3001-3011)

| cmd | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 3001 | CALL | C→S | 跟注 |
| 3002 | RAISE | C→S | 加注 |
| 3003 | CHECK | C→S | 过牌 |
| 3004 | FOLD | C→S | 弃牌 |
| 3005 | ALLIN | C→S | 全下 |
| 3006 | ACTION_RESULT | S→C | 行动结果广播 |
| 3007 | DEAL | S→C | 发底牌 |
| 3008 | YOUR_TURN | S→C | 轮到你行动 |
| 3009 | BLIND | S→C | 盲注信息 |
| 3010 | COMMUNITY | S→C | 公共牌 |
| 3011 | SHOWDOWN | S→C | 摊牌结果 |

## 协议详情

### 1. 盲注信息 (BLIND - 3009)

游戏开始时，服务器通知盲注信息。

```json
// S→C
{
  "cmd": 3009,
  "code": 0,
  "data": {
    "dealerSeat": 0,
    "smallBlindSeat": 1,
    "bigBlindSeat": 2,
    "smallBlind": 50,
    "bigBlind": 100,
    "pot": 150
  }
}
```

### 2. 发底牌 (DEAL - 3007)

每个玩家收到自己的2张底牌。

```json
// S→C (每个玩家只能看到自己的牌)
{
  "cmd": 3007,
  "code": 0,
  "data": {
    "cards": [1, 14],
    "seat": 0
  }
}
```

### 3. 轮到行动 (YOUR_TURN - 3008)

通知玩家轮到其行动。

```json
// S→C
{
  "cmd": 3008,
  "code": 0,
  "data": {
    "seat": 2,
    "callAmount": 100,
    "minRaise": 200,
    "maxRaise": 5000,
    "canCheck": false,
    "timeout": 30
  }
}
```

### 4. 跟注 (CALL - 3001)

```json
// C→S
{
  "cmd": 3001
}

// S→C (广播)
{
  "cmd": 3006,
  "code": 0,
  "data": {
    "seat": 2,
    "action": "call",
    "amount": 100,
    "pot": 500,
    "nextSeat": 3
  }
}
```

### 5. 加注 (RAISE - 3002)

```json
// C→S
{
  "cmd": 3002,
  "data": {
    "amount": 200
  }
}

// S→C (广播)
{
  "cmd": 3006,
  "code": 0,
  "data": {
    "seat": 3,
    "action": "raise",
    "amount": 200,
    "pot": 700,
    "nextSeat": 0
  }
}
```

### 6. 过牌 (CHECK - 3003)

```json
// C→S
{
  "cmd": 3003
}

// S→C (广播)
{
  "cmd": 3006,
  "code": 0,
  "data": {
    "seat": 1,
    "action": "check",
    "amount": 0,
    "pot": 500,
    "nextSeat": 2
  }
}
```

### 7. 弃牌 (FOLD - 3004)

```json
// C→S
{
  "cmd": 3004
}

// S→C (广播)
{
  "cmd": 3006,
  "code": 0,
  "data": {
    "seat": 4,
    "action": "fold",
    "amount": 0,
    "pot": 500,
    "nextSeat": 5
  }
}
```

### 8. 全下 (ALLIN - 3005)

```json
// C→S
{
  "cmd": 3005
}

// S→C (广播)
{
  "cmd": 3006,
  "code": 0,
  "data": {
    "seat": 2,
    "action": "allin",
    "amount": 3000,
    "pot": 3500,
    "nextSeat": 3
  }
}
```

### 9. 公共牌 (COMMUNITY - 3010)

```json
// S→C (翻牌 - 3张)
{
  "cmd": 3010,
  "code": 0,
  "data": {
    "stage": "flop",
    "cards": [0, 13, 26]
  }
}

// S→C (转牌 - 第4张)
{
  "cmd": 3010,
  "code": 0,
  "data": {
    "stage": "turn",
    "cards": [0, 13, 26, 39]
  }
}

// S→C (河牌 - 第5张)
{
  "cmd": 3010,
  "code": 0,
  "data": {
    "stage": "river",
    "cards": [0, 13, 26, 39, 51]
  }
}
```

### 10. 摊牌 (SHOWDOWN - 3011)

```json
// S→C
{
  "cmd": 3011,
  "code": 0,
  "data": {
    "results": [
      {
        "seat": 0,
        "cards": [1, 14],
        "bestHand": [1, 14, 0, 13, 26],
        "handType": "FLUSH",
        "handTypeName": "同花",
        "win": true,
        "amount": 1000
      },
      {
        "seat": 2,
        "cards": [5, 18],
        "bestHand": [5, 18, 0, 13, 26],
        "handType": "TWO_PAIR",
        "handTypeName": "两对",
        "win": false,
        "amount": 0
      }
    ],
    "pots": [
      {
        "amount": 1000,
        "winners": [0]
      }
    ]
  }
}
```

## 牌值编码

牌值采用 `花色 * 13 + 点数` 的编码方式：

### 花色

| 花色ID | 花色 |
|--------|------|
| 0 | ♠ 黑桃 |
| 1 | ♥ 红桃 |
| 2 | ♣ 梅花 |
| 3 | ♦ 方块 |

### 点数

| 点数ID | 点数 |
|--------|------|
| 0 | A |
| 1 | 2 |
| 2 | 3 |
| ... | ... |
| 9 | 10 |
| 10 | J |
| 11 | Q |
| 12 | K |

### 编码示例

| 牌值 | 计算 | 牌面 |
|------|------|------|
| 0 | 0*13+0 | ♠A |
| 1 | 0*13+1 | ♠2 |
| 12 | 0*13+12 | ♠K |
| 13 | 1*13+0 | ♥A |
| 26 | 2*13+0 | ♣A |
| 39 | 3*13+0 | ♦A |
| 51 | 3*13+12 | ♦K |

## 牌型定义

牌型从大到小排列：

| 牌型 | 英文名 | 说明 | 示例 |
|------|--------|------|------|
| 皇家同花顺 | ROYAL_FLUSH | 同花色10-J-Q-K-A | ♠10 ♠J ♠Q ♠K ♠A |
| 同花顺 | STRAIGHT_FLUSH | 同花色连续5张 | ♥5 ♥6 ♥7 ♥8 ♥9 |
| 四条 | FOUR_OF_A_KIND | 4张相同点数 | 8888K |
| 葫芦 | FULL_HOUSE | 三条+一对 | QQQJJ |
| 同花 | FLUSH | 5张同花色 | ♣2 ♣5 ♣8 ♣J ♣K |
| 顺子 | STRAIGHT | 连续5张 | 56789 |
| 三条 | THREE_OF_A_KIND | 3张相同点数 | 777AK |
| 两对 | TWO_PAIR | 2组对子 | KKQQ5 |
| 一对 | ONE_PAIR | 1组对子 | AA789 |
| 高牌 | HIGH_CARD | 无牌型 | AK852 |

### 牌型比较规则

1. 先比较牌型大小
2. 牌型相同时，比较组成牌型的牌点数
3. 点数相同时，比较踢脚牌（Kicker）
4. 完全相同则平分底池

## 错误码

| 错误码 | 说明 |
|--------|------|
| 3001 | 不是你的回合 |
| 3002 | 加注金额无效 |
| 3003 | 筹码不足 |
| 3004 | 不能过牌（需要跟注） |
| 3005 | 已经弃牌 |
| 3006 | 游戏未开始 |
| 3007 | 操作超时 |

## 特殊规则

### 盲注

- 小盲注（Small Blind）：庄家左边第一位，强制下注底池的一半
- 大盲注（Big Blind）：庄家左边第二位，强制下注底池

### 庄家轮换

每局结束后，庄家按顺时针方向轮换到下一位玩家。

### 全下（All-In）

- 玩家可以在任何时候全下
- 全下后不再参与后续下注
- 如果全下金额小于当前下注，会创建边池

### 边池（Side Pot）

当有玩家全下时，可能产生边池：

```json
{
  "pots": [
    {
      "amount": 3000,
      "eligibleSeats": [0, 1, 2, 3]
    },
    {
      "amount": 2000,
      "eligibleSeats": [1, 2, 3]
    }
  ]
}
```

### 超时处理

- 玩家行动超时自动弃牌
- 可配置超时时间（默认30秒）

## 断线重连

断线重连时，服务器会返回当前游戏状态：

```json
{
  "cmd": 2,
  "code": 0,
  "data": {
    "roomId": "room_123",
    "seats": [...],
    "game": {
      "stage": "flop",
      "dealerSeat": 0,
      "currentSeat": 2,
      "pot": 500,
      "myCards": [1, 14],
      "communityCards": [0, 13, 26],
      "callAmount": 100,
      "players": [
        {"seat": 0, "chips": 4500, "bet": 100, "folded": false},
        {"seat": 1, "chips": 4900, "bet": 50, "folded": false},
        {"seat": 2, "chips": 5000, "bet": 0, "folded": false}
      ]
    }
  }
}
```

## 客户端实现要点

1. **底牌保密**: 只显示自己的底牌，其他玩家底牌显示背面
2. **行动提示**: 根据 YOUR_TURN 消息显示可用操作按钮
3. **筹码动画**: 下注时显示筹码移动动画
4. **公共牌展示**: 分阶段展示公共牌（翻牌3张、转牌1张、河牌1张）
5. **边池显示**: 有边池时分别显示主池和边池
6. **倒计时**: 显示行动倒计时
7. **摊牌动画**: 摊牌时依次翻开各玩家底牌
