# 牛牛游戏协议文档

## 概述

牛牛（斗牛）是一款流行的扑克牌游戏，支持2-6人同时游戏。本文档描述客户端与牛牛游戏服务器之间的通信协议。

## 连接信息

- WebSocket端口: 9500
- HTTP管理端口: 9501
- 路径: `/game`

## 游戏流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         游戏开始                                 │
│                       确定庄家                                   │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【下注阶段】                               │
│                                                                 │
│                    闲家选择下注倍数                              │
│                     庄家不参与下注                               │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【发牌阶段】                               │
│                                                                 │
│                    每人发4张牌                                   │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                     【发第5张牌】                                │
│                                                                 │
│                   逐个发第5张牌                                  │
│                  增加游戏悬念感                                  │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【亮牌阶段】                               │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  玩家选择3张牌组成10的倍数（牛）                           │  │
│  │  剩余2张牌点数和决定牛几                                   │  │
│  │  或系统自动计算最优牛型                                    │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【结算阶段】                               │
│                                                                 │
│                  闲家与庄家比较牛型                              │
│                  计算输赢（含倍数）                              │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                        游戏结束                                  │
│                      庄家轮换                                    │
└─────────────────────────────────────────────────────────────────┘
```

## 游戏阶段

| 阶段 | 英文名 | 说明 |
|------|--------|------|
| 准备 | WAITING | 等待玩家准备 |
| 下注 | BETTING | 闲家下注 |
| 发牌 | DEALING | 发4张牌 |
| 发第5张 | FIFTH_CARD | 发第5张牌 |
| 亮牌 | SHOWING | 玩家亮牌 |
| 结算 | SETTLING | 计算输赢 |

## 命令号定义 (4001-4006)

| cmd | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 4001 | BET | C→S | 下注 |
| 4002 | BET_RESULT | S→C | 下注结果广播 |
| 4003 | SHOW | C→S | 亮牌 |
| 4004 | SHOW_RESULT | S→C | 亮牌结果广播 |
| 4005 | FIFTH_CARD | S→C | 第5张牌 |
| 4006 | SETTLE | S→C | 结算结果 |

## 协议详情

### 1. 游戏开始通知

游戏开始时，服务器通知庄家信息。

```json
// S→C
{
  "cmd": 100,
  "code": 0,
  "data": {
    "bankerSeat": 0,
    "betOptions": [1, 2, 3, 4, 5]
  }
}
```

### 2. 下注 (BET - 4001)

闲家选择下注倍数。

```json
// C→S
{
  "cmd": 4001,
  "data": {
    "amount": 100
  }
}

// S→C (广播)
{
  "cmd": 4002,
  "code": 0,
  "data": {
    "seat": 1,
    "amount": 100
  }
}
```

### 3. 发牌通知

发4张牌给每个玩家。

```json
// S→C (每个玩家只能看到自己的牌)
{
  "cmd": 101,
  "code": 0,
  "data": {
    "cards": [0, 13, 26, 39],
    "seat": 1
  }
}
```

### 4. 第5张牌 (FIFTH_CARD - 4005)

逐个发第5张牌。

```json
// S→C (广播，但只有对应玩家能看到牌值)
{
  "cmd": 4005,
  "code": 0,
  "data": {
    "seat": 1,
    "card": 51
  }
}

// S→C (其他玩家看到)
{
  "cmd": 4005,
  "code": 0,
  "data": {
    "seat": 2,
    "card": -1
  }
}
```

### 5. 亮牌 (SHOW - 4003)

玩家选择组成牛的3张牌。

```json
// C→S (选择3张牌的索引)
{
  "cmd": 4003,
  "data": {
    "cards": [0, 1, 2]
  }
}

// S→C (广播)
{
  "cmd": 4004,
  "code": 0,
  "data": {
    "seat": 1,
    "cards": [0, 13, 26, 39, 51],
    "niu": 9,
    "niuName": "牛九",
    "niuCards": [0, 13, 26]
  }
}
```

### 6. 结算 (SETTLE - 4006)

所有玩家亮牌后进行结算。

```json
// S→C
{
  "cmd": 4006,
  "code": 0,
  "data": {
    "banker": 0,
    "results": [
      {
        "seat": 0,
        "cards": [1, 14, 27, 40, 50],
        "niu": 10,
        "niuName": "牛牛",
        "niuCards": [1, 14, 27],
        "score": 300,
        "isBanker": true
      },
      {
        "seat": 1,
        "cards": [0, 13, 26, 39, 51],
        "niu": 7,
        "niuName": "牛七",
        "niuCards": [0, 13, 26],
        "score": -100,
        "isBanker": false
      },
      {
        "seat": 2,
        "cards": [2, 15, 28, 41, 49],
        "niu": 0,
        "niuName": "无牛",
        "niuCards": [],
        "score": -200,
        "isBanker": false
      }
    ]
  }
}
```

## 牌值编码

牌值采用 `花色 * 13 + 点数` 的编码方式：

### 花色

| 花色ID | 花色 |
|--------|------|
| 0 | ♠ 黑桃 |
| 1 | ♥ 红桃 |
| 2 | ♣ 梅花 |
| 3 | ♦ 方块 |

### 点数

| 点数ID | 点数 | 牛牛点数 |
|--------|------|----------|
| 0 | A | 1 |
| 1 | 2 | 2 |
| 2 | 3 | 3 |
| ... | ... | ... |
| 8 | 9 | 9 |
| 9 | 10 | 10 |
| 10 | J | 10 |
| 11 | Q | 10 |
| 12 | K | 10 |

### 编码示例

| 牌值 | 计算 | 牌面 | 点数 |
|------|------|------|------|
| 0 | 0*13+0 | ♠A | 1 |
| 9 | 0*13+9 | ♠10 | 10 |
| 10 | 0*13+10 | ♠J | 10 |
| 11 | 0*13+11 | ♠Q | 10 |
| 12 | 0*13+12 | ♠K | 10 |

## 牛型定义

牛型从小到大排列：

| 牛型 | 说明 | 倍数 | 示例 |
|------|------|------|------|
| 无牛 | 无法组成10的倍数 | 1 | 2♠ 3♥ 5♣ 7♦ 9♠ |
| 牛一 | 剩余2张点数和为1 | 1 | 10♠ 10♥ 10♣ A♦ K♠ |
| 牛二 | 剩余2张点数和为2 | 1 | 10♠ 10♥ 10♣ A♦ A♠ |
| 牛三 | 剩余2张点数和为3 | 1 | 10♠ 10♥ 10♣ A♦ 2♠ |
| 牛四 | 剩余2张点数和为4 | 1 | 10♠ 10♥ 10♣ A♦ 3♠ |
| 牛五 | 剩余2张点数和为5 | 1 | 10♠ 10♥ 10♣ A♦ 4♠ |
| 牛六 | 剩余2张点数和为6 | 1 | 10♠ 10♥ 10♣ A♦ 5♠ |
| 牛七 | 剩余2张点数和为7 | 2 | 10♠ 10♥ 10♣ A♦ 6♠ |
| 牛八 | 剩余2张点数和为8 | 2 | 10♠ 10♥ 10♣ A♦ 7♠ |
| 牛九 | 剩余2张点数和为9 | 3 | 10♠ 10♥ 10♣ A♦ 8♠ |
| 牛牛 | 剩余2张点数和为10/20 | 3 | 10♠ 10♥ 10♣ K♦ K♠ |
| 四花牛 | 4张花牌+1张10 | 4 | J♠ Q♥ K♣ J♦ 10♠ |
| 五花牛 | 5张全是花牌(J/Q/K) | 5 | J♠ Q♥ K♣ J♦ Q♠ |
| 炸弹牛 | 4张相同点数 | 5 | 8♠ 8♥ 8♣ 8♦ K♠ |
| 五小牛 | 5张牌点数和≤10 | 5 | A♠ A♥ 2♣ 2♦ 3♠ |

### 牛型计算规则

1. 从5张牌中选择3张，使其点数和为10的倍数
2. 剩余2张牌的点数和对10取余，即为牛几
3. 如果无法选出3张组成10的倍数，则为无牛
4. J、Q、K 都算10点

### 比牌规则

1. 先比较牛型大小
2. 牛型相同时，比较最大单牌点数
3. 点数相同时，比较花色（黑桃 > 红桃 > 梅花 > 方块）

## 错误码

| 错误码 | 说明 |
|--------|------|
| 4001 | 不是下注阶段 |
| 4002 | 下注金额无效 |
| 4003 | 庄家不能下注 |
| 4004 | 已经下过注 |
| 4005 | 不是亮牌阶段 |
| 4006 | 选择的牌无效 |
| 4007 | 筹码不足 |
| 4008 | 游戏未开始 |

## 特殊规则

### 庄家轮换

- 默认：每局结束后庄家顺时针轮换
- 可选：连庄模式（庄家赢则继续坐庄）
- 可选：抢庄模式（玩家可以抢庄）

### 抢庄模式

```json
// S→C (通知抢庄)
{
  "cmd": 4010,
  "code": 0,
  "data": {
    "timeout": 5
  }
}

// C→S (抢庄)
{
  "cmd": 4011,
  "data": {
    "grab": true,
    "multiple": 2
  }
}

// S→C (抢庄结果)
{
  "cmd": 4012,
  "code": 0,
  "data": {
    "bankerSeat": 2,
    "multiple": 2
  }
}
```

### 下注倍数

闲家可选择的下注倍数通常为 1-5 倍。

### 超时处理

- 下注超时：自动下注最小倍数
- 亮牌超时：系统自动计算最优牛型

## 断线重连

断线重连时，服务器会返回当前游戏状态：

```json
{
  "cmd": 2,
  "code": 0,
  "data": {
    "roomId": "room_123",
    "seats": [...],
    "game": {
      "stage": "showing",
      "bankerSeat": 0,
      "myCards": [0, 13, 26, 39, 51],
      "myBet": 100,
      "players": [
        {"seat": 0, "bet": 0, "shown": false, "isBanker": true},
        {"seat": 1, "bet": 100, "shown": true, "niu": 7},
        {"seat": 2, "bet": 200, "shown": false, "isBanker": false}
      ]
    }
  }
}
```

## 客户端实现要点

1. **牌面显示**: 清晰显示5张牌和点数
2. **牛型选择**: 提供选择3张牌的交互界面
3. **自动计算**: 提供自动计算最优牛型的按钮
4. **倍数显示**: 显示当前牛型对应的倍数
5. **结算动画**: 显示输赢筹码流动动画
6. **庄家标识**: 明显标识当前庄家
7. **倒计时**: 显示下注和亮牌倒计时
