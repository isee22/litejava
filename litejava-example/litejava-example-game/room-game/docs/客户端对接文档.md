# 客户端对接文档

本文档描述客户端如何与游戏服务端通信，适用于 Unity、Cocos、H5 等客户端开发。

## 1. 架构概览 (BabyKylin 模式)

```
┌─────────────┐     HTTP      ┌─────────────┐
│   Client    │ ────────────> │ HallServer  │
└─────────────┘               └─────────────┘
      │                              │
      │ WebSocket                    │ HTTP
      ▼                              ▼
┌─────────────┐               ┌─────────────┐
│ GameServer  │ <──────────── │AccountServer│
└─────────────┘   (注册/配置)  └─────────────┘
```

**核心原则：**
- 进入游戏前全部用 HTTP（登录、创建房间、加入房间）
- 进入游戏后用 WebSocket（实时游戏通信）
- 客户端直连 GameServer，无需 Gateway 代理
- 签名验证贯穿全流程

## 2. 服务端点

| 服务 | 端口 | 协议 | 说明 |
|------|------|------|------|
| Account Server | 8101 | HTTP | 登录/注册/玩家数据 |
| Hall Server | 8201 | HTTP | 房间创建/加入 |
| Game Server | 9100+ | WebSocket | 游戏实时通信 |

## 3. 完整流程

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│  客户端  │      │ Account │      │  Hall   │      │  Game   │
└────┬────┘      └────┬────┘      └────┬────┘      └────┬────┘
     │                │                │                │
     │ 1. POST /login │                │                │
     │───────────────>│                │                │
     │   {userId, roomId?}             │                │  ← roomId 用于断线重连
     │<───────────────│                │                │
     │                │                │                │
     │ 2. POST /create_room 或 /enter_room             │
     │────────────────────────────────>│                │
     │                │                │ 3. 选择服务器   │
     │                │                │ 4. 调用 GameServer
     │                │                │───────────────>│
     │   {roomId, ip, port, token, time, sign}         │  ← 带签名
     │<────────────────────────────────│                │
     │                │                │                │
     │ 5. WebSocket 连接 ws://ip:port/game             │
     │─────────────────────────────────────────────────>│
     │ 6. LOGIN {token, roomid, time, sign}            │  ← 带签名
     │─────────────────────────────────────────────────>│
     │   验证签名 + token，进入房间     │                │
     │<─────────────────────────────────────────────────│
```

## 4. HTTP API

### 4.1 Account Server (8101)

#### 登录
```http
POST /login
Content-Type: application/json

{"username": "test", "password": "123456"}
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "userId": 10001,
    "username": "test",
    "name": "玩家昵称",
    "coins": 10000,
    "roomId": "123456",    // 断线重连：如果在房间中则返回
    "serverId": "127.0.0.1:9100"
  }
}
```

#### 注册
```http
POST /register
Content-Type: application/json

{"username": "test", "password": "123456", "name": "玩家昵称"}
```

### 4.2 Hall Server (8201)

#### 创建房间
```http
POST /create_room
Content-Type: application/json

{
  "userId": 10001,
  "gameType": "doudizhu",
  "name": "玩家1",
  "conf": {}
}
```

**响应：**
```json
{
  "code": 0,
  "data": {
    "roomId": "123456",
    "ip": "127.0.0.1",
    "port": 9100,
    "token": "eyJ...",
    "time": 1704067200000,
    "sign": "a1b2c3d4..."
  }
}
```

#### 加入房间
```http
POST /enter_room
Content-Type: application/json

{
  "userId": 10002,
  "roomId": "123456",
  "name": "玩家2"
}
```

**响应格式同上**

#### 快速开始 (有房间就加入，没房间就创建)
```http
POST /quick_start
Content-Type: application/json

{
  "userId": 10001,
  "gameType": "doudizhu",
  "name": "玩家1"
}
```

**响应格式同上**

### 4.3 游戏类型

| gameType | 说明 | 人数 |
|----------|------|------|
| doudizhu | 斗地主 | 3 |
| gobang | 五子棋 | 2 |
| mahjong | 麻将 | 4 |
| texas | 德州扑克 | 2-9 |
| niuniu | 牛牛 | 2-6 |

## 5. WebSocket 协议

### 5.1 连接地址
```
ws://{ip}:{port}/game

示例: ws://127.0.0.1:9100/game
```

### 5.2 消息格式

**请求：**
```json
{"cmd": 1, "data": {...}}
```

**成功响应：**
```json
{"cmd": 1, "code": 0, "data": {...}}
```

**错误响应：**
```json
{"cmd": 1, "errcode": 2, "errmsg": "sign check failed"}
```

### 5.3 登录 (cmd=1)

**请求：** 必须带上 HallServer 返回的所有参数
```json
{
  "cmd": 1,
  "data": {
    "token": "eyJ...",
    "roomid": "123456",
    "time": 1704067200000,
    "sign": "a1b2c3d4..."
  }
}
```

**成功响应：**
```json
{
  "cmd": 1,
  "code": 0,
  "data": {
    "roomId": "123456",
    "ownerId": 10001,
    "seatIndex": 0,
    "seats": [
      {"seatIndex": 0, "userId": 10001, "name": "玩家1", "ready": false, "online": true},
      {"seatIndex": 1, "userId": 0, "name": "", "ready": false, "online": false}
    ],
    "game": null
  }
}
```

**错误响应：**
```json
{"cmd": 1, "errcode": 1, "errmsg": "invalid parameters"}
{"cmd": 1, "errcode": 2, "errmsg": "sign check failed"}
{"cmd": 1, "errcode": 3, "errmsg": "token out of time"}
```

### 5.4 心跳 (cmd=4)
```json
// 请求
{"cmd": 4}

// 响应
{"cmd": 4, "code": 0}
```

建议每 30 秒发送一次心跳。

### 5.5 准备 (cmd=504)
```json
// 请求
{"cmd": 504}

// 响应 (广播给房间所有人)
{"cmd": 504, "code": 0, "data": {"userId": 10001, "seatIndex": 0, "ready": true}}
```

### 5.6 退出房间 (cmd=106)
```json
// 请求
{"cmd": 106}

// 响应
{"cmd": 106, "code": 0}
```

## 6. 命令号速查

| 范围 | 说明 |
|------|------|
| 1-99 | 系统命令 (登录/心跳) |
| 100-499 | 房间/聊天 |
| 500-599 | 游戏通用命令 |
| 1000+ | 游戏特有命令 |

### 完整命令号表

| cmd | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 1 | LOGIN | C↔S | 登录 (token+roomid+time+sign) |
| 4 | PING | C↔S | 心跳 |
| 106 | ROOM_EXIT | C→S | 退出房间 |
| 150 | CHAT_SEND | C→S | 发送聊天 |
| 151 | CHAT_MSG | S→C | 聊天消息 |
| 500 | USER_JOIN | S→C | 有人加入 |
| 501 | USER_EXIT | S→C | 有人退出 |
| 502 | USER_STATE | S→C | 状态变化 (上线/离线/托管) |
| 504 | READY | C↔S | 准备 |
| 505 | CANCEL_READY | C→S | 取消准备 |
| 510 | GAME_START | S→C | 游戏开始 |
| 511 | GAME_OVER | S→C | 游戏结束 |
| 520 | DEAL | S→C | 发牌 |
| 522 | TURN | S→C | 轮到谁 |

## 7. 断线重连

### 流程
1. 客户端登录 AccountServer 时，检查响应中的 `roomId` 字段
2. 如果 `roomId` 不为空，说明玩家在房间中，需要重连
3. 使用 `serverId` 构造 WebSocket 地址，重新连接
4. 连接后需要重新调用 HallServer 获取新的 token

```javascript
// 登录后检查断线重连
const loginResp = await login(username, password)
if (loginResp.data.roomId) {
  // 需要重连
  const reconnectResp = await enterRoom(loginResp.data.userId, loginResp.data.roomId)
  await connectGame(reconnectResp.data)
}
```

## 8. 示例代码

### JavaScript (H5)
```javascript
class GameClient {
  constructor() {
    this.ws = null
    this.userId = null
  }
  
  // 1. HTTP 登录
  async login(username, password) {
    const resp = await fetch('http://localhost:8101/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    })
    const result = await resp.json()
    if (result.code === 0) {
      this.userId = result.data.userId
      // 检查断线重连
      if (result.data.roomId) {
        return { needReconnect: true, ...result }
      }
    }
    return result
  }
  
  // 2. HTTP 创建房间
  async createRoom(gameType, name) {
    const resp = await fetch('http://localhost:8201/create_room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: this.userId, gameType, name })
    })
    return resp.json()
  }
  
  // 3. HTTP 加入房间
  async enterRoom(roomId, name) {
    const resp = await fetch('http://localhost:8201/enter_room', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: this.userId, roomId, name })
    })
    return resp.json()
  }
  
  // 4. WebSocket 连接游戏
  async connectGame({ ip, port, token, roomId, time, sign }) {
    const wsUrl = `ws://${ip}:${port}/game`
    this.ws = new WebSocket(wsUrl)
    
    return new Promise((resolve, reject) => {
      this.ws.onopen = () => {
        // 发送登录 (带签名)
        this.send(1, { token, roomid: roomId, time, sign })
      }
      
      this.ws.onmessage = (e) => {
        const msg = JSON.parse(e.data)
        if (msg.cmd === 1) {
          if (msg.code === 0) {
            resolve(msg.data)
          } else {
            reject(new Error(msg.errmsg || '登录失败'))
          }
        }
        this.onMessage(msg)
      }
      
      this.ws.onerror = reject
    })
  }
  
  // 准备
  ready() {
    this.send(504, {})
  }
  
  // 发送消息
  send(cmd, data) {
    this.ws.send(JSON.stringify({ cmd, data }))
  }
  
  // 心跳
  startHeartbeat() {
    setInterval(() => this.send(4, {}), 30000)
  }
  
  // 处理消息
  onMessage(msg) {
    switch (msg.cmd) {
      case 504: console.log('准备状态:', msg.data); break
      case 510: console.log('游戏开始'); break
      case 511: console.log('游戏结束:', msg.data); break
      case 520: console.log('发牌:', msg.data); break
      case 522: console.log('轮到:', msg.data); break
    }
  }
}

// 使用示例
const client = new GameClient()

// 登录
const loginResult = await client.login('test', '123456')

// 创建房间
const roomResult = await client.createRoom('doudizhu', '玩家1')
if (roomResult.code === 0) {
  // 连接游戏 (带签名)
  await client.connectGame(roomResult.data)
  client.startHeartbeat()
  client.ready()
}
```

## 9. 游戏协议文档

各游戏的详细协议参见：
- [斗地主协议](./game/斗地主协议.md)
- [五子棋协议](./game/五子棋协议.md)
- [麻将协议](./game/麻将协议.md)
- [德州扑克协议](./game/德州扑克协议.md)
- [牛牛协议](./game/牛牛协议.md)
