# 客户端对接文档

本文档描述客户端如何与游戏服务端通信，适用于 Unity、Cocos、H5 等客户端开发。

## 1. 架构概览 (BabyKylin 模式)

```
┌─────────────┐     HTTP      ┌─────────────┐
│   Client    │ ────────────> │ HallServer  │
└─────────────┘               └─────────────┘
      │                              │
      │ WebSocket                    │ HTTP
      ▼                              ▼
┌─────────────┐               ┌─────────────┐
│ GameServer  │ <──────────── │AccountServer│
└─────────────┘   (注册/配置)  └─────────────┘
```

**核心原则：**
- 进入游戏前全部用 HTTP（登录、创建房间、匹配）
- 进入游戏后用 WebSocket（实时游戏通信）
- 客户端直连 GameServer，无需 Gateway 代理

## 2. 服务端点

### 开发环境 (直连)

| 服务 | 端口 | 协议 | 说明 |
|------|------|------|------|
| Account Server | 8101 | HTTP | 登录/注册/玩家数据 |
| Hall Server | 8201 | HTTP | 房间创建/加入/匹配 |
| Game Server | 9100+ | WebSocket | 游戏实时通信 |

### 生产环境 (Nginx 代理)

| 路径 | 后端服务 | 说明 |
|------|----------|------|
| `/api/account/*` | Account Server (8101) | 账号相关 |
| `/api/hall/*` | Hall Server (8201) | 大厅相关 |
| `/ws/game/*` | Game Servers (可选) | WebSocket 代理 |

**统一入口**: 所有 HTTP 请求通过 Nginx (80/443)，隐藏后端 IP/端口

## 3. 连接流程

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌─────────┐
│  客户端  │      │ Account │      │  Hall   │      │  Game   │
└────┬────┘      └────┬────┘      └────┬────┘      └────┬────┘
     │                │                │                │
     │ 1. HTTP 登录   │                │                │
     │───────────────>│                │                │
     │   {userId}     │                │                │
     │<───────────────│                │                │
     │                │                │                │
     │ 2. HTTP 创建/加入房间           │                │
     │────────────────────────────────>│                │
     │                │                │ 3. 选择服务器   │
     │                │                │ 4. 调用 GameServer
     │                │                │───────────────>│
     │   {roomid, ip, port, token}     │                │
     │<────────────────────────────────│                │
     │                │                │                │
     │ 5. WebSocket 连接 GameServer    │                │
     │─────────────────────────────────────────────────>│
     │ 6. LOGIN {token}                │                │
     │─────────────────────────────────────────────────>│
     │   验证 token，进入房间           │                │
     │<─────────────────────────────────────────────────│
```

## 4. HTTP API

### API 地址

| 环境 | Account API | Hall API |
|------|-------------|----------|
| 开发 | `http://localhost:8101` | `http://localhost:8201` |
| 生产 | `/api/account` | `/api/hall` |

### 4.1 Account Server

#### 登录
```bash
# 开发环境
POST http://localhost:8101/auth/login

# 生产环境 (Nginx)
POST /api/account/auth/login

Content-Type: application/json
{"username": "test", "password": "123456"}

# 响应
{"code": 0, "data": {"userId": 10001, "name": "玩家昵称"}}
```

#### 注册
```bash
POST /auth/register
Content-Type: application/json

{"username": "test", "password": "123456", "name": "玩家昵称"}

# 响应
{"code": 0, "data": {"userId": 10001}}
```

#### 获取玩家信息
```bash
GET /player/{userId}

# 响应
{"code": 0, "data": {"userId": 10001, "name": "玩家", "coins": 10000}}
```

### 4.2 Hall Server

#### 创建私人房间
```bash
# 开发环境
GET http://localhost:8201/create_private_room?userId=10001&gameType=doudizhu&conf={}

# 生产环境 (Nginx)
GET /api/hall/create_private_room?userId=10001&gameType=doudizhu&conf={}

# 响应
{
  "code": 0,
  "data": {
    "roomid": "123456",
    "ip": "127.0.0.1",
    "port": 9100,
    "token": "xxx"
  }
}
```

#### 加入私人房间
```bash
GET /enter_private_room?userId=10002&roomid=123456&name=玩家2

# 响应
{
  "code": 0,
  "data": {
    "roomid": "123456",
    "ip": "127.0.0.1",
    "port": 9100,
    "token": "xxx"
  }
}
```

#### 开始匹配
```bash
POST /match/start
Content-Type: application/json

{"userId": 10001, "gameType": "doudizhu", "level": "normal", "name": "玩家1"}

# 响应 (匹配成功)
{
  "code": 0,
  "data": {
    "status": "matched",
    "roomid": "234567",
    "ip": "127.0.0.1",
    "port": 9100,
    "token": "xxx"
  }
}

# 响应 (等待中)
{"code": 0, "data": {"status": "matching"}}
```

#### 取消匹配
```bash
POST /match/cancel
Content-Type: application/json

{"userId": 10001}

# 响应
{"code": 0}
```

### 4.3 游戏类型

| gameType | 说明 | 人数 |
|----------|------|------|
| doudizhu | 斗地主 | 3 |
| gobang | 五子棋 | 2 |
| mahjong | 麻将 | 4 |
| texas | 德州扑克 | 2-9 |
| niuniu | 牛牛 | 2-6 |
| werewolf | 狼人杀 | 6-12 |

## 5. WebSocket 协议

### 5.1 连接地址
```
ws://{ip}:{port}/{gameType}

示例: ws://127.0.0.1:9100/doudizhu
```

### 5.2 消息格式

```json
// 请求
{"cmd": 1, "data": {"token": "xxx"}}

// 响应（成功）
{"cmd": 1, "code": 0, "data": {...}}

// 响应（失败）
{"cmd": 1, "code": 5, "msg": "错误信息"}
```

### 5.3 登录 (cmd=1)
```json
// 请求 (使用 Hall 返回的 token)
{"cmd": 1, "data": {"token": "xxx"}}

// 响应
{
  "cmd": 1,
  "code": 0,
  "data": {
    "seatIndex": 0,
    "roomId": "123456",
    "players": [...]
  }
}
```

### 5.4 心跳 (cmd=4)
```json
// 请求
{"cmd": 4}

// 响应
{"cmd": 4, "code": 0}
```

建议每 30 秒发送一次心跳。

### 5.5 准备 (cmd=504)
```json
// 请求
{"cmd": 504}

// 响应
{"cmd": 504, "code": 0}
```

### 5.6 服务器推送

| cmd | 说明 |
|-----|------|
| 500 | 有人加入房间 |
| 501 | 有人退出房间 |
| 502 | 玩家状态变化（上线/离线/托管） |
| 503 | 玩家准备状态 |
| 510 | 游戏开始 |
| 511 | 游戏结束 |
| 512 | 游戏状态（断线重连） |
| 520 | 发牌 |
| 521 | 摸牌 |
| 522 | 轮到谁 |

## 6. 命令号速查

| 范围 | 说明 |
|------|------|
| 1-99 | 系统命令 (登录/心跳) |
| 500-599 | 游戏通用命令 |
| 1000+ | 游戏特有命令 |

### 完整命令号表

| cmd | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 1 | LOGIN | C↔S | 登录 (token) |
| 3 | LOGOUT | C→S | 登出 |
| 4 | PING | C↔S | 心跳 |
| 500 | USER_JOIN | S→C | 有人加入 |
| 501 | USER_EXIT | S→C | 有人退出 |
| 502 | USER_STATE | S→C | 状态变化 |
| 503 | USER_READY | S→C | 准备状态 |
| 504 | READY | C↔S | 准备 |
| 510 | GAME_START | S→C | 游戏开始 |
| 511 | GAME_OVER | S→C | 游戏结束 |
| 512 | GAME_STATE | S→C | 游戏状态 |
| 520 | DEAL | S→C | 发牌 |
| 521 | DRAW | S→C | 摸牌 |
| 522 | TURN | S→C | 轮到谁 |
| 530 | RECONNECT | C↔S | 断线重连 |

## 7. 示例代码

### JavaScript (H5)
```javascript
class GameClient {
  constructor() {
    this.ws = null
    this.userId = null
  }
  
  // 1. HTTP 登录
  async login(username, password) {
    const resp = await fetch('http://localhost:8101/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password })
    })
    const result = await resp.json()
    if (result.code === 0) {
      this.userId = result.data.userId
    }
    return result
  }
  
  // 2. HTTP 创建房间
  async createRoom(gameType) {
    const resp = await fetch(
      `http://localhost:8201/create_private_room?userId=${this.userId}&gameType=${gameType}&conf={}`
    )
    return resp.json()
  }
  
  // 3. HTTP 开始匹配
  async startMatch(gameType, name) {
    const resp = await fetch('http://localhost:8201/match/start', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId: this.userId, gameType, level: 'normal', name })
    })
    return resp.json()
  }
  
  // 4. WebSocket 连接游戏
  async connectGame(ip, port, gameType, token) {
    const wsUrl = `ws://${ip}:${port}/${gameType}`
    this.ws = new WebSocket(wsUrl)
    
    return new Promise((resolve, reject) => {
      this.ws.onopen = () => {
        // 发送登录
        this.send(1, { token })
      }
      
      this.ws.onmessage = (e) => {
        const msg = JSON.parse(e.data)
        if (msg.cmd === 1 && msg.code === 0) {
          resolve(msg.data)
        } else if (msg.cmd === 1) {
          reject(new Error('登录失败'))
        }
        this.onMessage(msg)
      }
    })
  }
  
  // 准备
  ready() {
    this.send(504, {})
  }
  
  // 发送消息
  send(cmd, data) {
    this.ws.send(JSON.stringify({ cmd, data }))
  }
  
  // 处理消息
  onMessage(msg) {
    switch (msg.cmd) {
      case 510: console.log('游戏开始'); break
      case 511: console.log('游戏结束:', msg.data); break
      case 520: console.log('发牌:', msg.data); break
      case 522: console.log('轮到:', msg.data); break
    }
  }
}

// 使用示例
const client = new GameClient()

// 登录
await client.login('test', '123456')

// 匹配
const matchResult = await client.startMatch('doudizhu', '玩家1')
if (matchResult.data.status === 'matched') {
  const { ip, port, token } = matchResult.data
  await client.connectGame(ip, port, 'doudizhu', token)
  client.ready()
}
```

## 8. 游戏协议文档

各游戏的详细协议参见：
- [斗地主协议](./game/斗地主协议.md)
- [五子棋协议](./game/五子棋协议.md)
- [麻将协议](./game/麻将协议.md)
- [狼人杀协议](./game/狼人杀协议.md)
- [德州扑克协议](./game/德州扑克协议.md)
- [牛牛协议](./game/牛牛协议.md)
- [MOBA协议](./game/MOBA协议.md)
