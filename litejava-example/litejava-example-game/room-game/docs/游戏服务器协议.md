# 游戏服务器协议

用于实现多语言版本的游戏服务器，只要遵循此协议即可无缝替换。

## 概述

GameServer 是具体玩法的实现服务器，如斗地主、麻将、五子棋等。每种玩法可以用任意语言实现，只要遵循本协议即可与系统无缝集成。

### 架构位置

```
┌─────────┐     ┌─────────┐     ┌─────────────┐
│ Gateway │────▶│  Lobby  │────▶│ GameServer  │
│         │     │  Match  │     │ (你要实现的) │
└─────────┘     └─────────┘     └─────────────┘
      │                               ▲
      │                               │
      └───────────────────────────────┘
              (游戏消息代理)
```

### 职责
- 房间管理 (创建/加入/退出)
- 游戏逻辑 (发牌/出牌/判定)
- 状态同步 (广播/断线重连)
- 录像记录 (可选)

## 1. 服务注册

### 1.1 ServiceId 分配策略

**ServiceId 由注册中心分配**，保证全局唯一：

```
serviceId = {serviceType}-{序号}

示例:
- game-doudizhu-1
- game-doudizhu-2
```

### 1.2 地址配置 (支持 Docker/K8s)

| 配置项 | 环境变量 | 配置文件 | 说明 |
|--------|----------|----------|------|
| 外部IP | `ADVERTISE_HOST` | `server.advertiseHost` | 客户端连接的IP |
| 外部WS端口 | `ADVERTISE_WS_PORT` | `server.advertiseWsPort` | 客户端连接的WS端口 |
| 外部HTTP端口 | `ADVERTISE_HTTP_PORT` | `server.advertiseHttpPort` | 服务间调用的HTTP端口 |

### 1.3 注册请求

```
POST http://{registry}/register
{
  "serviceType": "game-doudizhu",
  "host": "192.168.1.100",
  "port": 9101,
  "metadata": {
    "wsPort": 9100,
    "rooms": 0,
    "players": 0
  }
}
```

### 1.4 心跳

每 10 秒发送心跳，上报负载信息：

```
POST http://{registry}/heartbeat
{
  "serviceType": "game-doudizhu",
  "serviceId": "game-doudizhu-1",
  "metadata": {
    "rooms": 5,
    "players": 12,
    "cpu": 25,
    "memory": 60
  }
}
```

## 2. HTTP 接口

### 2.1 创建房间
```
POST /room/create
{ "userId": 10001, "conf": {"players": 3} }

响应:
{ "code": 0, "data": {"roomId": "123456"} }
```

### 2.2 加入房间
```
POST /room/join
{ "roomId": "123456", "userId": 10002 }

响应:
{ "code": 0, "data": {"roomId": "123456"} }
```

**说明：** 用户信息（name等）由 HallServer 从 Redis 读取后传递给 GameServer

### 2.3 房间列表
```
GET /rooms

响应:
{ "code": 0, "data": [{"roomId": "123456", "players": 2, "maxPlayers": 3}] }
```

### 2.4 踢人
```
POST /kick
{ "roomId": "123456", "ownerId": 10001, "targetId": 10002 }
```

### 2.5 房间信息
```
GET /room/{roomId}
```

### 2.6 健康检查
```
GET /health
```

## 3. WebSocket 协议

连接地址: `ws://{host}:{wsPort}/{gameType}`

### 3.1 消息格式

```json
{
  "cmd": 1,
  "code": 0,
  "data": {}
}
```

### 3.2 通用命令 (500-599)

| cmd | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 1 | LOGIN | C→S | 登录房间 |
| 500 | USER_JOIN | S→C | 有人加入 |
| 501 | USER_EXIT | S→C | 有人退出 |
| 502 | USER_STATE | S→C | 状态变化 |
| 503 | USER_READY | S→C | 准备状态广播 |
| 504 | READY | C→S | 准备 |
| 510 | GAME_START | S→C | 游戏开始 |
| 511 | GAME_OVER | S→C | 游戏结束 |
| 512 | GAME_STATE | S→C | 游戏状态（断线重连） |
| 520 | DEAL | S→C | 发牌 |
| 521 | DRAW | S→C | 摸牌 |
| 522 | TURN | S→C | 轮到谁 |
| 530 | RECONNECT | C→S | 断线重连 |

### 3.3 游戏命令 (1000+)

各游戏自定义，如斗地主：

| cmd | 名称 | 说明 |
|-----|------|------|
| 1001 | CALL_SCORE | 叫分 |
| 1002 | CALL_SCORE_RESULT | 叫分结果 |
| 1003 | PLAY_CARD | 出牌 |
| 1004 | PLAY_CARD_RESULT | 出牌结果 |
| 1005 | PASS | 不出 |

## 4. Gateway 代理模式

Gateway 作为纯代理，根据 cmd 范围转发消息：

| cmd 范围 | 转发目标 |
|----------|----------|
| 1-99 | 系统处理 (LOGIN 转发到 Lobby) |
| 100-149 | Lobby `/ws/room` |
| 150-199 | Lobby `/ws/chat` |
| 300-499 | Match `/ws/match` |
| 500+ | GameServer (通过代理连接) |

### 4.1 游戏连接建立流程

1. 客户端发送创建/加入房间请求到 Gateway
2. Gateway 转发到 Lobby
3. Lobby 调用 GameServer HTTP 接口创建/加入房间
4. Lobby 回调 Gateway `/callback/room` 通知建立游戏连接
5. Gateway 建立到 GameServer 的 WebSocket 连接
6. 后续游戏消息通过 Gateway 代理转发

## 5. 注意事项

1. **服务类型命名**: `game-{gameType}`
2. **心跳间隔**: 10 秒
3. **WebSocket 路径**: `/{gameType}`
4. **JSON 编码**: UTF-8
5. **响应格式**: 统一使用 `{code, data}` 格式
