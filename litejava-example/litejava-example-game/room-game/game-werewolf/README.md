# 狼人杀游戏服务器 (game-werewolf)

狼人杀是一款经典的社交推理游戏，玩家分为好人阵营和狼人阵营，通过发言、投票和技能使用来达成各自的胜利条件。

## 游戏规则

### 角色配置

| 人数 | 狼人 | 预言家 | 女巫 | 守卫 | 猎人 | 村民 |
|------|------|--------|------|------|------|------|
| 6人  | 2    | 1      | 1    | -    | -    | 2    |
| 8人  | 2    | 1      | 1    | 1    | 1    | 2    |
| 9人  | 3    | 1      | 1    | 1    | 1    | 2    |
| 12人 | 4    | 1      | 1    | 1    | 1    | 4    |

### 角色技能

- **狼人**: 夜晚可以杀死一名玩家
- **预言家**: 夜晚可以查验一名玩家的身份
- **女巫**: 拥有一瓶解药和一瓶毒药，各只能使用一次
- **守卫**: 夜晚可以守护一名玩家（不能连续守护同一人）
- **猎人**: 死亡时可以开枪带走一名玩家（被毒死除外）
- **村民**: 无特殊技能

### 胜利条件

- **好人阵营**: 所有狼人死亡
- **狼人阵营**: 狼人数量 >= 好人数量

## 游戏流程

```
┌─────────────────────────────────────────────────────────────────┐
│                         游戏开始                                 │
│                      分配角色并通知                              │
│                   (狼人互相知道同伴)                             │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【夜晚阶段】                               │
│                                                                 │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │
│  │ 狼人杀人  │ → │预言家查验 │ → │ 女巫用药  │ → │ 守卫守护  │  │
│  │ (投票)   │    │ (查身份) │    │(救/毒)   │    │ (保护)   │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │
│                                                                 │
│  规则:                                                          │
│  - 狼人需要统一意见选择目标                                      │
│  - 女巫可以看到今晚被杀的人                                      │
│  - 守卫不能连续两晚守护同一人                                    │
│  - 同守同救无效 (守卫和女巫同时保护同一人则该人死亡)              │
└─────────────────────────────────────────────────────────────────┘
                               ↓
┌─────────────────────────────────────────────────────────────────┐
│                       【白天阶段】                               │
│                                                                 │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │
│  │ 公布死讯  │ → │   遗言   │ → │   发言   │ → │   投票   │  │
│  │          │    │ (死者)   │    │ (轮流)   │    │ (公投)   │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │
│                                                                 │
│  规则:                                                          │
│  - 死者可以发表遗言                                              │
│  - 存活玩家按座位顺序发言                                        │
│  - 投票票数最多者出局 (平票则无人出局)                           │
│  - 猎人死亡时可以开枪带走一人                                    │
└─────────────────────────────────────────────────────────────────┘
                               ↓
                    检查胜负 → 未结束则回到夜晚
```

## 通信协议

### 命令号定义 (700-799)

| 命令 | 命令号 | 方向 | 说明 |
|------|--------|------|------|
| WOLF_KILL | 701 | C→S | 狼人杀人 |
| WOLF_KILL_RESULT | 702 | S→C | 狼人杀人结果 |
| SEER_CHECK | 703 | C→S | 预言家查验 |
| SEER_CHECK_RESULT | 704 | S→C | 查验结果 |
| WITCH_USE | 705 | C→S | 女巫用药 |
| WITCH_USE_RESULT | 706 | S→C | 用药结果 |
| GUARD_PROTECT | 707 | C→S | 守卫守护 |
| GUARD_PROTECT_RESULT | 708 | S→C | 守护结果 |
| HUNTER_SHOOT | 709 | C→S | 猎人开枪 |
| HUNTER_SHOOT_RESULT | 710 | S→C | 开枪结果 |
| SPEAK | 720 | C→S | 发言 |
| SPEAK_BROADCAST | 721 | S→C | 发言广播 |
| VOTE | 722 | C→S | 投票 |
| VOTE_RESULT | 723 | S→C | 投票结果 |
| PHASE_CHANGE | 730 | S→C | 阶段变更 |
| DEATH_ANNOUNCE | 731 | S→C | 死亡通知 |
| GAME_OVER | 732 | S→C | 游戏结束 |
| ROLE_ASSIGN | 733 | S→C | 角色分配 |
| YOUR_TURN | 734 | S→C | 轮到行动 |
| WOLF_TEAMMATES | 735 | S→C | 狼人同伴 |

### 协议示例

#### 1. 角色分配
```json
// S→C: 通知玩家角色
{
  "cmd": 733,
  "code": 0,
  "data": {
    "role": 2,
    "roleName": "预言家"
  }
}
```

#### 2. 狼人杀人
```json
// C→S: 狼人选择目标
{
  "cmd": 701,
  "data": {
    "targetSeat": 3
  }
}

// S→C: 通知所有狼人
{
  "cmd": 702,
  "code": 0,
  "data": {
    "wolfSeat": 0,
    "targetSeat": 3,
    "confirmed": true,
    "finalTarget": 3
  }
}
```

#### 3. 预言家查验
```json
// C→S: 查验目标
{
  "cmd": 703,
  "data": {
    "targetSeat": 2
  }
}

// S→C: 查验结果 (仅预言家可见)
{
  "cmd": 704,
  "code": 0,
  "data": {
    "targetSeat": 2,
    "isWolf": true
  }
}
```

#### 4. 女巫用药
```json
// C→S: 使用药水
{
  "cmd": 705,
  "data": {
    "useAntidote": true,
    "usePoison": false,
    "poisonTarget": -1
  }
}
```

#### 5. 投票
```json
// C→S: 投票
{
  "cmd": 722,
  "data": {
    "targetSeat": 5
  }
}

// S→C: 投票结果
{
  "cmd": 723,
  "code": 0,
  "data": {
    "votes": {"0": 5, "1": 5, "2": 3, "3": 5},
    "eliminatedSeat": 5
  }
}
```

## 项目结构

```
game-werewolf/
├── pom.xml
├── README.md
└── src/main/
    ├── java/game/werewolf/
    │   ├── WerewolfServer.java   # 服务器主类
    │   ├── WerewolfGame.java     # 游戏逻辑
    │   ├── WwCmd.java            # 命令号定义
    │   ├── WwErr.java            # 错误码定义
    │   └── vo/                   # 数据传输对象
    │       ├── WwRoleVO.java
    │       ├── WwPhaseVO.java
    │       ├── WwTurnVO.java
    │       └── ...
    └── resources/
        └── application.yml       # 配置文件
```

## 配置说明

```yaml
server:
  host: localhost
  wsPort: 9600      # WebSocket端口
  httpPort: 9601    # HTTP管理端口

game:
  type: werewolf
  maxPlayers: 8     # 默认8人局 (支持6/8/9/12人)

registry:
  url: http://localhost:8000
```

## 启动方式

```bash
# 编译
mvn clean package -pl game-werewolf -am

# 运行
java -jar game-werewolf/target/game-werewolf-1.0.0-jdk8.jar
```

## 语音聊天说明

狼人杀游戏非常适合语音交流，可以通过以下方式实现：

### 方案一: WebRTC P2P (推荐小房间)
- 适合6-8人小房间
- 客户端直接建立P2P连接
- 服务器只负责信令转发
- 延迟低，服务器压力小

### 方案二: SFU媒体服务器 (推荐大房间)
- 适合9人以上房间
- 使用 mediasoup / Janus 等SFU服务器
- 每个客户端只需上传一路流
- 服务器负责转发给其他人

### 信令协议 (预留)
```json
// 开始语音
{"cmd": 750, "data": {}}

// 结束语音
{"cmd": 751, "data": {}}

// WebRTC信令
{"cmd": 752, "data": {"type": "offer/answer/candidate", "sdp": "...", "candidate": "..."}}
```

语音功能需要额外的WebRTC实现，建议使用现成的SDK如 Agora、声网 或自建 mediasoup 服务。
